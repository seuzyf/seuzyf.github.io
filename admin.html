<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #D64550;
            --bg-color: rgba(15, 25, 35, 0.85);
            --text-color: #ece8e1;
            --card-bg-color: rgba(26, 40, 54, 0.8);
            --header-bg-color: rgba(26, 40, 54, 0.85);
            --border-color: #2a3a49;
            --success-color: #4CAF50;
            --shadow-color: rgba(0,0,0,0.3);
            --control-height: 42px;
        }
        body.light-theme {
            --primary-color: #D64550;
            --bg-color: rgba(240, 242, 245, 0.85);
            --text-color: #1c1e21;
            --card-bg-color: rgba(255, 255, 255, 0.8);
            --header-bg-color: rgba(255, 255, 255, 0.85);
            --border-color: #dadde1;
            --shadow-color: rgba(0,0,0,0.1);
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px 0;
            background-image: url('https://cdnb.artstation.com/p/assets/images/images/053/266/803/large/cai-husband-champions-2022-rev01.jpg?1661819637');
            background-attachment: fixed;
            background-size: cover;
        }
        .container { width: 95%; max-width: 1600px; margin: 0 auto; }
        .main-header-block {
            background-color: var(--header-bg-color);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 16px var(--shadow-color);
            text-align: center;
            margin-bottom: 40px;
            border: 1px solid var(--border-color);
            position: relative;
        }
        .main-header-block h1 { color: var(--primary-color); margin: 0 0 10px 0; font-weight: 700; font-size: 2.5em; }
        .controls-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
        }
        .filter-group, .nav-button {
            height: var(--control-height);
            display: inline-flex;
            align-items: center;
            border-radius: 8px;
            font-weight: 500;
        }
        .filter-group { background-color: var(--card-bg-color); padding: 5px; border: 1px solid var(--border-color); }
        .filter-group button {
            padding: 0 15px;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            opacity: 0.7;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9em;
            height: 100%;
            transition: background-color 0.3s, color 0.3s;
        }
        .filter-group button.active { background-color: var(--primary-color); color: white; opacity: 1; }
        .nav-button {
            padding: 0 25px;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            text-decoration: none;
            transition: background-color 0.3s, color 0.3s;
        }
        .nav-button:hover { background-color: var(--primary-color); color: white; }
        .top-right-controls { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 15px; }
        #theme-text { font-size: 0.8em; opacity: 0.8; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { background-color: var(--border-color); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: var(--text-color); bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(24px); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-section, .table-section {
            background-color: var(--card-bg-color);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
            margin-top: 2rem;
        }
        .form-section h3, .table-section h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; border: 1px solid var(--border-color); text-align: left; }
        thead th { background-color: rgba(214, 69, 80, 0.2); white-space: nowrap; }

        input, select {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
            min-width: 60px;
        }
        input[readonly] { background-color: #333; opacity: 0.7; cursor: not-allowed; }
        td.actions { text-align: center; }
        button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button.success { background-color: var(--success-color); }
        .add-row-btn, .edit-match-btn { margin-bottom: 1rem; }
        .delete-row-btn { background-color: #7f8c8d; }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px);
            z-index: 1000; display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--card-bg-color);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 12px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #password-input { font-size: 1.2em; text-align: center; margin: 1rem 0; }
        .match-record { border-bottom: 3px solid var(--primary-color); margin-bottom: 1rem; padding-bottom: 1rem;}
        .match-record:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <datalist id="teams-datalist"></datalist>

    <div id="password-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2>请输入管理口令</h2>
            <input type="password" id="password-input" autofocus>
            <button id="password-submit">进入</button>
        </div>
    </div>

    <div id="admin-panel" class="container" style="display: none;">
        <header class="main-header-block">
             <div class="top-right-controls">
                <span id="theme-text"></span>
                <label class="theme-switch">
                    <input type="checkbox" id="theme-toggle-checkbox">
                    <span class="slider"></span>
                </label>
            </div>
            <h1>管理后台</h1>
            <div class="controls-container">
                 <div class="filter-group" id="group-filter-buttons">
                    <button class="active" data-group="传奇组">传奇组</button>
                    <button data-group="中坚组">中坚组</button>
                    <button data-group="挑战组">挑战组</button>
                </div>
            </div>
            <div class="controls-container">
                <a href="index.html" class="nav-button">返回比赛中心</a>
                <a href="summary.html" class="nav-button">查看选手数据</a>
                <a href="draft.html" class="nav-button">进行分队</a>
            </div>
            <div class="controls-container">
                <div class="filter-group" id="tab-filters">
                    <button class="active" data-tab="matches-tab">赛果管理</button>
                    <button data-tab="schedule-tab">赛程管理</button>
                    <button data-tab="ids-tab">ID 维护</button>
                </div>
            </div>
        </header>

        <div id="matches-tab" class="tab-content active">
            <div class="form-section">
                <h3>新增赛果</h3>
                <button class="add-row-btn" data-table="matches-table-body">新增记录</button>
                <div id="matches-form-container"></div>
                <button class="success" style="margin-top: 1rem;" id="submit-matches">提交新赛果</button>
            </div>
            
            <div class="form-section">
                <h3>修改赛果</h3>
                <select id="edit-match-selector" style="margin-bottom: 1rem;"></select>
                <div id="edit-match-form-container"></div>
                <button class="success" style="margin-top: 1rem; display: none;" id="update-match">更新赛果</button>
            </div>
        </div>

        <div id="schedule-tab" class="tab-content">
            <div class="form-section">
                <h3>更新赛程比分</h3>
                <select id="match-selector" style="margin-bottom: 1rem;"></select>
                <div id="schedule-update-form" style="display: none;">
                     <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr><th>队伍A</th><th>A队得分</th><th>B队得分</th><th>队伍B</th><th>比赛时间</th><th>回放链接</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><select id="schedule-team-a" disabled></select></td>
                                    <td><input type="number" id="schedule-score-a" placeholder="得分"></td>
                                    <td><input type="number" id="schedule-score-b" placeholder="得分"></td>
                                    <td><select id="schedule-team-b" disabled></select></td>
                                    <td><input type="datetime-local" id="schedule-date"></td>
                                    <td><input type="text" id="schedule-link" placeholder="https://..."></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="success" style="margin-top: 1rem;" id="submit-schedule">更新赛程</button>
                </div>
            </div>
        </div>

        <div id="ids-tab" class="tab-content">
             <div class="table-section">
                <h3>选手 ID 与荣誉维护</h3>
                <button class="add-row-btn" data-table="ids-table-body">新增记录</button>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>选手真名 (主键)</th>
                                <th>选手 ID</th>
                                <th>所属队伍</th>
                                <th>头像链接</th>
                                <th>选手荣誉 (用"、"分割)</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="ids-table-body"></tbody>
                    </table>
                </div>
                <button class="success" style="margin-top: 1rem;" id="update-ids">更新/添加 ID</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SUPABASE_URL = 'https://vbyvolmtkjjyeiibpljf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZieXZvbG10a2pqeWVpaWJwbGpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NzMxNDksImV4cCI6MjA3MjI0OTE0OX0.Tnot1kIVn8vJ-vggYaTGBGTkIBY7m6yIOquSjG5mSUM';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    const passwordModal = document.getElementById('password-modal');
    const adminPanel = document.getElementById('admin-panel');
    const passwordInput = document.getElementById('password-input');
    const passwordSubmit = document.getElementById('password-submit');

    let allPlayersData = [];
    let groupData = { '传奇组': { teams: new Set(), rosters: {} }, '中坚组': { teams: new Set(), rosters: {} }, '挑战组': { teams: new Set(), rosters: {} } };
    let currentScheduleData = [];
    let currentMatchesForEdit = [];

    const matchIdToName = {
        'S1-1': '0-0组-第1场', 'S1-2': '0-0组-第2场', 'S1-3': '0-0组-第3场', 'S1-4': '0-0组-第4场',
        'S2-1W': '1-0组-第1场', 'S2-2W': '1-0组-第2场',
        'S2-1L': '0-1组-第1场', 'S2-2L': '0-1组-第2场',
        'S3-1M': '1-1组-第1场', 'S3-2M': '1-1组-第2场',
        'P-WB1-1': '胜者组-第一轮-第1场', 'P-WB1-2': '胜者组-第一轮-第2场',
        'P-WBF': '胜者组-决赛',
        'P-LB1': '败者组-第一轮',
        'P-LBF': '败者组-决赛',
        'P-GF': '总决赛'
    };

    async function checkPassword() {
        const inputPassword = passwordInput.value;
        if (!inputPassword) { alert('请输入口令！'); return; }
        try {
            const { data, error } = await supabaseClient.from('manage').select('password').limit(1).single();
            if (error) throw error;
            if (data && data.password === inputPassword) {
                passwordModal.style.display = 'none';
                adminPanel.style.display = 'block';
                initializeAdminPanel();
            } else {
                alert('口令错误！');
            }
        } catch (error) {
            console.error('验证口令时出错:', error);
            alert('验证失败，请检查数据库连接和表设置。');
        }
    }
    passwordSubmit.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkPassword(); });

    async function initializeAdminPanel() {
        await loadInitialData();
        setupThemeToggle();
        setupTabs();
        setupDynamicRows();
        setupGroupFilters();
        
        const currentGroup = getCurrentGroup();
        loadIdsData(currentGroup);
        await loadScheduleForGroup(currentGroup);
        await loadMatchesForEditing(currentGroup);

        document.getElementById('submit-matches').addEventListener('click', submitMatches);
        document.getElementById('update-match').addEventListener('click', updateMatch);
        document.getElementById('match-selector').addEventListener('change', loadSelectedMatch);
        document.getElementById('edit-match-selector').addEventListener('change', displayMatchForEditing);
        document.getElementById('submit-schedule').addEventListener('click', submitSchedule);
        document.getElementById('update-ids').addEventListener('click', updateIds);
    }
    
    async function loadInitialData() {
        const { data, error } = await supabaseClient.from('player_ids').select('id, name, team, "group", image, honor');
        if (error) { console.error('无法加载选手数据:', error); return; }
        
        allPlayersData = data;
        groupData = { '传奇组': { teams: new Set(), rosters: {} }, '中坚组': { teams: new Set(), rosters: {} }, '挑战组': { teams: new Set(), rosters: {} } };

        data.forEach(player => {
            const playerGroup = player.group;
            if (groupData[playerGroup]) {
                if (player.team) {
                    groupData[playerGroup].teams.add(player.team);
                    if (!groupData[playerGroup].rosters[player.team]) groupData[playerGroup].rosters[player.team] = [];
                    groupData[playerGroup].rosters[player.team].push({ id: player.id, name: player.name });
                }
            }
        });
        updateTeamDatalist();
    }

    async function loadScheduleForGroup(groupName) {
        const { data, error } = await supabaseClient
            .from('match_schedule')
            .select('*')
            .eq('group', groupName)
            .order('id');
        if (error) {
            console.error(`加载 ${groupName} 赛程失败:`, error);
            currentScheduleData = [];
        } else {
            currentScheduleData = data.filter(m => m.team_a && m.team_a !== 'TBD');
        }
        populateMatchSelector();
        document.getElementById('schedule-update-form').style.display = 'none';
    }

    function populateMatchSelector() {
        const selector = document.getElementById('match-selector');
        selector.innerHTML = '<option value="">-- 请选择一场比赛 --</option>';
        if (currentScheduleData.length > 0) {
            currentScheduleData.forEach(match => {
                const option = document.createElement('option');
                option.value = match.id; 
                option.textContent = `${matchIdToName[match.match_id] || match.match_id}: ${match.team_a} vs ${match.team_b}`;
                selector.appendChild(option);
            });
        }
    }

    function getTeamOptionsHTML(teamName) {
        return `<option value="${teamName}" selected>${teamName}</option>`;
    }

    function loadSelectedMatch() {
        const selector = document.getElementById('match-selector');
        const matchId = selector.value;
        const form = document.getElementById('schedule-update-form');
        if (!matchId) {
            form.style.display = 'none';
            return;
        }

        const matchData = currentScheduleData.find(m => m.id == matchId);
        if (matchData) {
            document.getElementById('schedule-team-a').innerHTML = getTeamOptionsHTML(matchData.team_a);
            document.getElementById('schedule-team-b').innerHTML = getTeamOptionsHTML(matchData.team_b);
            
            document.getElementById('schedule-score-a').value = matchData.score_a ?? '';
            document.getElementById('schedule-score-b').value = matchData.score_b ?? '';
            const dateValue = matchData.match_date ? new Date(new Date(matchData.match_date).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : '';
            document.getElementById('schedule-date').value = dateValue;
            document.getElementById('schedule-link').value = matchData.link || '';
            form.style.display = 'block';
        }
    }

    function updateTeamDatalist() {
        const currentGroup = getCurrentGroup();
        const teams = groupData[currentGroup] ? [...groupData[currentGroup].teams].sort() : [];
        const teamDatalistHTML = teams.map(t => `<option value="${t}"></option>`).join('');
        document.getElementById('teams-datalist').innerHTML = teamDatalistHTML;
    }

    function getCurrentGroup() {
        return document.querySelector('#group-filter-buttons button.active').dataset.group;
    }
    
    function getTeamSelectOptionsHTMLForCurrentGroup(selectedTeam = '') {
        const currentGroup = getCurrentGroup();
        const teams = groupData[currentGroup] ? [...groupData[currentGroup].teams].sort() : [];
        return '<option value="">选择队伍</option>' + teams.map(t => `<option value="${t}" ${t === selectedTeam ? 'selected' : ''}>${t}</option>`).join('');
    }

    function setupGroupFilters() {
        const groupFilterButtons = document.getElementById('group-filter-buttons');
        groupFilterButtons.addEventListener('click', async (e) => {
            if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
                groupFilterButtons.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                const newGroup = e.target.dataset.group;
                updateTeamDatalist();
                loadIdsData(newGroup);
                document.getElementById('matches-form-container').innerHTML = '';
                document.getElementById('edit-match-form-container').innerHTML = '';
                document.getElementById('update-match').style.display = 'none';
                await loadScheduleForGroup(newGroup);
                await loadMatchesForEditing(newGroup);
            }
        });
    }

    function setupThemeToggle() {
        const themeToggle = document.getElementById('theme-toggle-checkbox');
        const themeText = document.getElementById('theme-text');
        function setTheme(isLight) {
            document.body.classList.toggle('light-theme', isLight);
            themeToggle.checked = isLight;
            themeText.textContent = isLight ? '点击切换夜间模式' : '点击切换日间模式';
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }
        const savedTheme = localStorage.getItem('theme');
        setTheme((savedTheme === null) ? true : (savedTheme === 'light'));
        themeToggle.addEventListener('change', (e) => setTheme(e.target.checked));
    }

    function setupTabs() {
        const tabFilters = document.getElementById('tab-filters');
        const tabContents = document.querySelectorAll('.tab-content');
        tabFilters.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
                tabFilters.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                const tabId = e.target.dataset.tab;
                tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === tabId);
                });
            }
        });
    }

    const stageOptions = `<option value="小组赛">小组赛</option><option value="淘汰赛第一轮">淘汰赛第一轮</option><option value="胜者组决赛">胜者组决赛</option><option value="败者组第一轮">败者组第一轮</option><option value="败者组决赛">败者组决赛</option><option value="决赛">决赛</option>`;
    const characterOptions = ['幻棱','钛狐','维斯','暮蝶','零','K/O','壹决','不死鸟','捷风','蝰蛇','雷兹','炼狱','猎枭','奇乐','芮娜','铁臂','贤者','幽影','尚勃勒','斯凯','霓虹','夜露','海神','星礈','盖可','钢锁','黑梦'].map(c => `<option value="${c}">${c}</option>`).join('');
    const mapOptions = ['源工重镇', '隐世修所', '霓虹町', '亚海悬城', '幽邃地库', '森寒冬港', '微风岛屿', '莲华古城', '日落之城', '深海明珠', '盐海矿镇'].map(m => `<option value="${m}">${m}</option>`).join('');
    
    const rowTemplates = {
        'matches-table-body': (isEditMode = false, data = {}) => {
            const recordDiv = document.createElement('div');
            recordDiv.className = 'match-record';
            
            let commonInputs = `
                <div style="overflow-x:auto;"><table style="width:100%; margin-bottom:1rem;">
                    <tr>
                        <td><strong>赛段:</strong> <select data-col="stage">${stageOptions}</select></td>
                        <td><strong>日期:</strong> <input type="date" data-col="match_date"></td>
                        <td><strong>地图:</strong> <select data-col="map">${mapOptions}</select></td>
                        <td><strong>比分:</strong> <input type="text" data-col="score" placeholder="eg: 13:9"></td>
                    </tr>
                </table></div>`;

            let teamA_Inputs = createTeamTable('A', isEditMode ? data.team_a : '');
            let teamB_Inputs = createTeamTable('B', isEditMode ? data.team_b : '');
            
            recordDiv.innerHTML = commonInputs + teamA_Inputs + teamB_Inputs;

            if (!isEditMode) {
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '删除该记录';
                deleteBtn.className = 'delete-row-btn';
                deleteBtn.onclick = () => recordDiv.remove();
                const deleteContainer = document.createElement('div');
                deleteContainer.style.textAlign = 'right';
                deleteContainer.style.padding = '10px';
                deleteContainer.appendChild(deleteBtn);
                recordDiv.appendChild(deleteContainer);
            }
            
            if (isEditMode) {
                 // Populate the form with existing data
                recordDiv.querySelector('[data-col="stage"]').value = data.stage || '小组赛';
                recordDiv.querySelector('[data-col="match_date"]').value = data.match_date || '';
                recordDiv.querySelector('[data-col="map"]').value = data.map || '源工重镇';
                recordDiv.querySelector('[data-col="score"]').value = data.score || '';

                ['a', 'b'].forEach(teamLabel => {
                    for (let i = 1; i <= 5; i++) {
                        const prefix = `team_${teamLabel}_player${i}`;
                        recordDiv.querySelector(`[data-col="${prefix}_id"]`).value = data[`${prefix}_id`] || '';
                        recordDiv.querySelector(`[data-col="${prefix}_ch"]`).value = data[`${prefix}_ch`] || '幻棱';
                        
                        const statsData = data[`${prefix}_data`];
                        if(statsData) {
                            const [acs, k, d, a] = String(statsData).split('/');
                            recordDiv.querySelector(`[data-col="${prefix}_acs"]`).value = acs || '';
                            recordDiv.querySelector(`[data-col="${prefix}_k"]`).value = k || '';
                            recordDiv.querySelector(`[data-col="${prefix}_d"]`).value = d || '';
                            recordDiv.querySelector(`[data-col="${prefix}_a"]`).value = a || '';
                        }
                    }
                });
            }

            return recordDiv;
        },
        'ids-table-body': (isNew = true, data = { id: '', name: '', team: '', image: '', honor: '' }) => {
            const tr = document.createElement('tr');
            tr.dataset.isNew = isNew;
            tr.innerHTML = `
                <td><input type="text" data-col="name" value="${data.name || ''}" ${!isNew ? 'readonly' : ''}></td>
                <td><input type="text" data-col="id" value="${data.id || ''}"></td>
                <td><input type="text" data-col="team" value="${data.team || ''}" list="teams-datalist"></td>
                <td><input type="text" data-col="image" value="${data.image || ''}"></td>
                <td><input type="text" data-col="honor" value="${data.honor || ''}"></td>
                <td class="actions">
                    <button class="delete-row-btn" onclick="handleDeleteId(this)">删除该记录</button>
                </td>`;
            return tr;
        }
    };
    
    function createTeamTable(teamLabel, selectedTeam) {
        const teamKey = `team_${teamLabel.toLowerCase()}`;
        const datalistId = `team-${teamLabel.toLowerCase()}-players-datalist`;
        let table = `<div style="overflow-x:auto;"><table style="width:100%; margin-bottom: 1rem;">
            <thead>
                <tr>
                    <th>队伍 ${teamLabel}</th>
                    <th>选手 ID</th><th>角色</th>
                    <th>ACS</th><th>K</th><th>D</th><th>A</th>
                </tr>
            </thead>
            <tbody>
                 <tr>
                    <td rowspan="5" style="vertical-align: middle;"><select data-col="${teamKey}" class="team-selector">${getTeamSelectOptionsHTMLForCurrentGroup(selectedTeam)}</select></td>
                    ${Array(5).fill(0).map((_, i) => `
                        ${i > 0 ? '<tr>' : ''}
                        <td><input type="text" data-col="${teamKey}_player${i+1}_id" placeholder="ID/选择" list="${datalistId}"></td>
                        <td><select data-col="${teamKey}_player${i+1}_ch">${characterOptions}</select></td>
                        <td><input type="number" data-col="${teamKey}_player${i+1}_acs" placeholder="ACS"></td>
                        <td><input type="number" data-col="${teamKey}_player${i+1}_k" placeholder="K"></td>
                        <td><input type="number" data-col="${teamKey}_player${i+1}_d" placeholder="D"></td>
                        <td><input type="number" data-col="${teamKey}_player${i+1}_a" placeholder="A"></td>
                        ${i > 0 ? '</tr>' : ''}
                    `).join('')}
                </tr>
            </tbody>
        </table></div>`;
        return table;
    }
    
    function handleTeamChange(e) {
        if (e.target.classList.contains('team-selector')) {
            const selectedTeam = e.target.value;
            const currentGroup = getCurrentGroup();
            const roster = groupData[currentGroup]?.rosters[selectedTeam] || [];
            
            const teamLabel = e.target.dataset.col === 'team_a' ? 'a' : 'b';
            const datalistId = `team-${teamLabel}-players-datalist`;
            
            const datalist = document.getElementById(datalistId) || document.createElement('datalist');
            datalist.id = datalistId;
            datalist.innerHTML = roster.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            if (!document.getElementById(datalistId)) document.body.appendChild(datalist);

            const table = e.target.closest('table');
            for(let i = 1; i <= 5; i++) {
                const idInput = table.querySelector(`input[data-col="team_${teamLabel}_player${i}_id"]`);
                if(idInput) idInput.value = roster[i-1] ? roster[i-1].id : '';
            }
        }
    }

    document.getElementById('matches-form-container').addEventListener('change', handleTeamChange);
    document.getElementById('edit-match-form-container').addEventListener('change', handleTeamChange);

    function setupDynamicRows() {
        document.querySelectorAll('.add-row-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tableId = btn.dataset.table;
                let container;
                if (tableId === 'matches-table-body') {
                    container = document.getElementById('matches-form-container');
                     const newRecord = rowTemplates['matches-table-body']();
                    container.appendChild(newRecord);
                } else {
                    container = document.getElementById(tableId);
                     const newRow = rowTemplates[tableId]();
                    container.appendChild(newRow);
                }
            });
        });
    }

    function getMatchDataFromContainer(containerId) {
        const container = document.getElementById(containerId);
        const rows = container.querySelectorAll('.match-record');
        
        const data = [];
        const selectedGroup = getCurrentGroup();

        rows.forEach(row => {
            const rowData = {};
            rowData.group = selectedGroup;

            row.querySelectorAll('input, select').forEach(input => {
                if (input.dataset.col) {
                    let value = input.value.trim();
                    if (value !== '' && value !== null) {
                         if (input.type === 'number' && value !== '') value = parseFloat(value);
                         rowData[input.dataset.col] = value;
                    }
                }
            });
            if (Object.keys(rowData).length > 1) data.push(rowData);
        });
        
        const processedData = data.map(row => {
            const newRow = { ...row };
            ['a', 'b'].forEach(teamLabel => {
                for (let i = 1; i <= 5; i++) {
                    const prefix = `team_${teamLabel}_player${i}`;
                    const acs = newRow[`${prefix}_acs`];
                    const k = newRow[`${prefix}_k`];
                    const d = newRow[`${prefix}_d`];
                    const a = newRow[`${prefix}_a`];
                    
                    if (newRow[`${prefix}_id`]) {
                         newRow[`${prefix}_data`] = `${acs || 0}/${k || 0}/${d || 0}/${a || 0}`;
                    }
                    delete newRow[`${prefix}_acs`]; delete newRow[`${prefix}_k`];
                    delete newRow[`${prefix}_d`]; delete newRow[`${prefix}_a`];
                }
            });
            return newRow;
        });
        
        return processedData;
    }

    async function submitMatches() {
        const data = getMatchDataFromContainer('matches-form-container');
        if (data.length === 0) return alert('没有要提交的数据。');

        for (const row of data) {
            if (!row.group || !row.stage || !row.team_a || !row.team_b) return alert('请确保每条记录的赛段和队伍名都已填写！');
        }

        const { error } = await supabaseClient.from('matches').insert(data);
        if (error) { alert('提交赛果失败: ' + error.message); console.error(error); }
        else { 
            alert('赛果提交成功！'); 
            document.getElementById('matches-form-container').innerHTML = ''; 
            await loadMatchesForEditing(getCurrentGroup());
        }
    }
    
    async function updateMatch() {
        const matchId = document.getElementById('edit-match-selector').value;
        if (!matchId) {
            alert('未选择任何比赛进行更新。');
            return;
        }

        const data = getMatchDataFromContainer('edit-match-form-container');
        if (data.length === 0) return alert('没有要更新的数据。');
        const matchData = data[0];

        const { error } = await supabaseClient.from('matches').update(matchData).eq('id', matchId);

        if (error) {
            alert('更新赛果失败: ' + error.message);
            console.error(error);
        } else {
            alert('赛果更新成功！');
            document.getElementById('edit-match-form-container').innerHTML = '';
            document.getElementById('update-match').style.display = 'none';
            await loadMatchesForEditing(getCurrentGroup());
        }
    }
    
    async function loadMatchesForEditing(groupName) {
        const selector = document.getElementById('edit-match-selector');
        selector.innerHTML = '<option value="">-- 请选择一场比赛进行修改 --</option>';

        const { data, error } = await supabaseClient
            .from('matches')
            .select('*')
            .eq('group', groupName)
            .order('match_date', { ascending: false });

        if (error) {
            console.error('加载可编辑比赛列表失败:', error);
            currentMatchesForEdit = [];
        } else {
            currentMatchesForEdit = data;
            data.forEach(match => {
                const option = document.createElement('option');
                option.value = match.id;
                option.textContent = `[${match.match_date}] ${match.team_a} vs ${match.team_b} (${match.map})`;
                selector.appendChild(option);
            });
        }
    }

    function displayMatchForEditing() {
        const selector = document.getElementById('edit-match-selector');
        const matchId = selector.value;
        const container = document.getElementById('edit-match-form-container');
        const updateBtn = document.getElementById('update-match');

        if (!matchId) {
            container.innerHTML = '';
            updateBtn.style.display = 'none';
            return;
        }

        const matchData = currentMatchesForEdit.find(m => m.id == matchId);
        if (matchData) {
            container.innerHTML = '';
            const editForm = rowTemplates['matches-table-body'](true, matchData);
            container.appendChild(editForm);
            updateBtn.style.display = 'inline-block';
        }
    }
    
    async function submitSchedule() {
        const matchIdString = document.getElementById('match-selector').value;
        if (!matchIdString) { alert('请先选择一场比赛。'); return; }

        const matchId = parseInt(matchIdString, 10);
        const scoreA = document.getElementById('schedule-score-a').value;
        const scoreB = document.getElementById('schedule-score-b').value;
        const scheduleDate = document.getElementById('schedule-date').value;
        
        const dataToUpdate = {
            score_a: scoreA === '' ? null : parseInt(scoreA, 10),
            score_b: scoreB === '' ? null : parseInt(scoreB, 10),
            match_date: scheduleDate ? new Date(scheduleDate).toISOString() : null,
            link: document.getElementById('schedule-link').value.trim()
        };

        const { data, error } = await supabaseClient.from('match_schedule').update(dataToUpdate).eq('id', matchId).select();

        if (error) {
            alert('错误：更新赛程失败！\n' + error.message); console.error(error);
        } else if (data && data.length > 0) {
            alert('赛程比分已成功写入数据库！');
            await loadScheduleForGroup(getCurrentGroup());
        } else {
            alert('更新失败：未找到匹配的比赛记录。请检查数据库的行级安全(RLS)策略是否允许本次更新操作。');
        }
    }

    function loadIdsData(groupName) {
        const tableBody = document.getElementById('ids-table-body');
        tableBody.innerHTML = '<tr><td colspan="6">正在加载...</td></tr>';
        
        const filteredData = allPlayersData.filter(p => p.group === groupName);

        tableBody.innerHTML = '';
        if (filteredData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6">该组别下没有选手数据。</td></tr>`;
        } else {
            filteredData.forEach(player => tableBody.appendChild(rowTemplates['ids-table-body'](false, player)));
        }
    }
    
    function getIdsTableData() {
        const rows = document.querySelectorAll(`#ids-table-body tr`);
        const data = [];
        const selectedGroup = getCurrentGroup();
        rows.forEach(row => {
            if (row.querySelector('td[colspan="6"]')) return;
            const rowData = {};
            rowData.isNew = row.dataset.isNew === 'true';
            rowData.group = selectedGroup;
            row.querySelectorAll('input, select').forEach(input => {
                if (input.dataset.col) {
                    let value = input.value.trim();
                     if (value !== '' && value !== null) rowData[input.dataset.col] = value;
                }
            });
            if (Object.keys(rowData).length > 1) data.push(rowData);
        });
        return data;
    }

    async function updateIds() {
        const dataToUpsert = getIdsTableData();
        if (dataToUpsert.length === 0) return alert('没有要更新或添加的数据。');
        
        const existingNames = new Set(allPlayersData.map(p => p.name));
        for (const row of dataToUpsert) {
            if (row.isNew) {
                if (!row.name) return alert('新增选手的真名不能为空！');
                if (existingNames.has(row.name)) {
                    return alert(`提交失败：选手真名 "${row.name}" 已存在，不允许添加同名选手。`);
                }
            }
        }
        
        const dbData = dataToUpsert.map(row => {
            const { isNew, ...dbRow } = row;
            return dbRow;
        });

        const { error } = await supabaseClient.from('player_ids').upsert(dbData, { onConflict: 'name' });

        if (error) { 
            alert('更新失败: ' + error.message); console.error(error);
        } else { 
            alert('选手数据更新成功！'); 
            await loadInitialData();
            loadIdsData(getCurrentGroup());
        }
    }
    
    async function handleDeleteId(deleteBtn) {
        const tr = deleteBtn.closest('tr');
        const playerName = tr.querySelector('input[data-col="name"]').value;
        const isNewRow = tr.dataset.isNew === 'true';

        if (isNewRow || !playerName) {
            tr.remove();
            return;
        }
        
        if (confirm(`您确定要从数据库中永久删除选手 "${playerName}" 吗？此操作不可撤销。`)) {
            const { error } = await supabaseClient.from('player_ids').delete().eq('name', playerName);
            if (error) {
                alert(`删除失败: ${error.message}`);
            } else {
                alert(`选手 "${playerName}" 已成功删除。`);
                tr.remove();
                allPlayersData = allPlayersData.filter(p => p.name !== playerName);
            }
        }
    }
    window.handleDeleteId = handleDeleteId;
});
</script>
</body>
</html>