<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #D64550;
            --bg-color: rgba(15, 25, 35, 0.95);
            --text-color: #ece8e1;
            --card-bg-color: rgba(26, 40, 54, 0.9);
            --border-color: #2a3a49;
            --success-color: #4CAF50;
            --shadow-color: rgba(0,0,0,0.3);
            --control-height: 42px;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px 0;
        }
        .container { width: 95%; max-width: 1600px; margin: 20px auto; }
        h1, h2 { color: var(--primary-color); text-align: center; }
        .nav-tabs { display: flex; justify-content: center; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color); }
        .nav-tabs button { padding: 1rem 1.5rem; border: none; background: none; color: var(--text-color); cursor: pointer; font-size: 1.1em; border-bottom: 3px solid transparent; }
        .nav-tabs button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-section, .table-section { background-color: var(--card-bg-color); padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); }
        .form-section h3, .table-section h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; border: 1px solid var(--border-color); text-align: left; }
        thead th { background-color: rgba(214, 69, 80, 0.2); }
        tbody tr:nth-child(even) { background-color: rgba(0,0,0,0.2); }

        input, select {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
        }
        td.actions { text-align: center; }
        button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button.success { background-color: var(--success-color); }
        button.add-row-btn { margin-bottom: 1rem; }
        .delete-row-btn { background-color: #7f8c8d; }
        
        /* Modal Styles */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px);
            z-index: 1000; display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--card-bg-color); padding: 2rem;
            border-radius: 12px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #password-input { font-size: 1.2em; text-align: center; margin: 1rem 0; }
    </style>
</head>
<body>

    <div id="password-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2>请输入管理口令</h2>
            <input type="password" id="password-input" autofocus>
            <button id="password-submit">进入</button>
        </div>
    </div>

    <div id="admin-panel" class="container" style="display: none;">
        <h1>管理后台</h1>
        <div class="nav-tabs">
            <button class="tab-button active" data-tab="matches-tab">赛果管理</button>
            <button class="tab-button" data-tab="schedule-tab">赛程管理</button>
            <button class="tab-button" data-tab="ids-tab">ID 维护</button>
        </div>

        <div id="matches-tab" class="tab-content active">
            <div class="form-section">
                <h3>新增赛果</h3>
                <button class="add-row-btn" data-table="matches-table-body">新增一行</button>
                <div style="overflow-x: auto;">
                    <table id="matches-form">
                        <thead>
                            <tr>
                                <th>组别</th><th>赛段</th><th>日期</th><th>地图</th><th>比分</th>
                                <th>队伍A</th><th>A-P1 ID</th><th>A-P1 角色</th><th>A-P1 数据</th>
                                <th>队伍B</th><th>B-P5 ID</th><th>B-P5 角色</th><th>B-P5 数据</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="matches-table-body">
                            </tbody>
                    </table>
                </div>
                <button class="success" style="margin-top: 1rem;" id="submit-matches">提交赛果</button>
            </div>
        </div>

        <div id="schedule-tab" class="tab-content">
            <div class="form-section">
                <h3>新增赛程</h3>
                <button class="add-row-btn" data-table="schedule-table-body">新增一行</button>
                <table>
                    <thead>
                        <tr>
                            <th>组别</th><th>Match ID</th><th>队伍 A</th><th>队伍 B</th>
                            <th>A队得分</th><th>B队得分</th><th>回放链接</th><th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-table-body">
                        </tbody>
                </table>
                <button class="success" style="margin-top: 1rem;" id="submit-schedule">提交赛程</button>
            </div>
        </div>

        <div id="ids-tab" class="tab-content">
            <div class="table-section">
                <h3>选手 ID 维护</h3>
                <button class="add-row-btn" data-table="ids-table-body">新增一行</button>
                <table>
                    <thead>
                        <tr><th>选手 ID (主键)</th><th>选手真名</th><th>操作</th></tr>
                    </thead>
                    <tbody id="ids-table-body">
                        </tbody>
                </table>
                <button class="success" style="margin-top: 1rem;" id="update-ids">更新/添加 ID</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SUPABASE_URL = 'https://vbyvolmtkjjyeiibpljf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZieXZvbG10a2pqeWVpaWJwbGpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NzMxNDksImV4cCI6MjA3MjI0OTE0OX0.Tnot1kIVn8vJ-vggYaTGBGTkIBY7m6yIOquSjG5mSUM';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    const passwordModal = document.getElementById('password-modal');
    const adminPanel = document.getElementById('admin-panel');
    const passwordInput = document.getElementById('password-input');
    const passwordSubmit = document.getElementById('password-submit');

    // --- 认证逻辑 ---
    async function checkPassword() {
        const inputPassword = passwordInput.value;
        if (!inputPassword) {
            alert('请输入口令！');
            return;
        }
        try {
            const { data, error } = await supabaseClient
                .from('manage')
                .select('password')
                .limit(1)
                .single();
            
            if (error) throw error;
            
            if (data && data.password === inputPassword) {
                passwordModal.style.display = 'none';
                adminPanel.style.display = 'block';
                initializeAdminPanel();
            } else {
                alert('口令错误！');
            }
        } catch (error) {
            console.error('验证口令时出错:', error);
            alert('验证失败，请检查数据库连接和表设置。');
        }
    }
    passwordSubmit.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') checkPassword();
    });

    // --- 面板初始化 ---
    function initializeAdminPanel() {
        setupTabs();
        setupDynamicRows();
        loadIdsData();

        document.getElementById('submit-matches').addEventListener('click', submitMatches);
        document.getElementById('submit-schedule').addEventListener('click', submitSchedule);
        document.getElementById('update-ids').addEventListener('click', updateIds);
    }
    
    // --- Tab 切换逻辑 ---
    function setupTabs() {
        const tabButtons = document.querySelectorAll('.nav-tabs .tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === button.dataset.tab) {
                        content.classList.add('active');
                    }
                });
            });
        });
    }

    // --- 动态增删行逻辑 ---
    const groupOptions = `<option value="传奇组">传奇组</option><option value="中坚组">中坚组</option><option value="挑战组">挑战组</option>`;
    const stageOptions = `<option value="小组赛">小组赛</option><option value="淘汰赛">淘汰赛</option><option value="决赛">决赛</option>`;
    const scheduleMatchIdOptions = `
        <option value="S1-1">S1-1: 瑞士轮 0-0组 第1场</option><option value="S1-2">S1-2: 瑞士轮 0-0组 第2场</option>
        <option value="S1-3">S1-3: 瑞士轮 0-0组 第3场</option><option value="S1-4">S1-4: 瑞士轮 0-0组 第4场</option>
        <option value="S2-1W">S2-1W: 瑞士轮 1-0组 第1场</option><option value="S2-2W">S2-2W: 瑞士轮 1-0组 第2场</option>
        <option value="S2-1L">S2-1L: 瑞士轮 0-1组 第1场</option><option value="S2-2L">S2-2L: 瑞士轮 0-1组 第2场</option>
        <option value="S3-1M">S3-1M: 瑞士轮 1-1组 第1场</option><option value="S3-2M">S3-2M: 瑞士轮 1-1组 第2场</option>
        <option value="P-WB1-1">P-WB1-1: 胜者组 R1 第1场</option><option value="P-WB1-2">P-WB1-2: 胜者组 R1 第2场</option>
        <option value="P-WBF">P-WBF: 胜者组 决赛</option><option value="P-LB1">P-LB1: 败者组 R1</option>
        <option value="P-LBF">P-LBF: 败者组 决赛</option><option value="P-GF">P-GF: 总决赛</option>`;

    function createDeleteButton() {
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '删除';
        deleteBtn.className = 'delete-row-btn';
        deleteBtn.onclick = (e) => e.target.closest('tr').remove();
        return deleteBtn;
    }

    const rowTemplates = {
        'matches-table-body': () => {
            const tr = document.createElement('tr');
            let playerInputs = '';
            for (const team of ['a', 'b']) {
                playerInputs += `<td><input type="text" data-col="team_${team}" placeholder="队伍${team.toUpperCase()}"></td>`;
                for (let i = 1; i <= 5; i++) {
                    playerInputs += `
                        <td><input type="text" data-col="team_${team}_player${i}_id" placeholder="ID"></td>
                        <td><input type="text" data-col="team_${team}_player${i}_ch" placeholder="角色"></td>
                        <td><input type="text" data-col="team_${team}_player${i}_data" placeholder="ACS/K/D/A"></td>`;
                }
            }
            tr.innerHTML = `
                <td><select data-col="group">${groupOptions}</select></td>
                <td><select data-col="stage">${stageOptions}</select></td>
                <td><input type="date" data-col="match_date"></td>
                <td><input type="text" data-col="map" placeholder="地图名"></td>
                <td><input type="text" data-col="score" placeholder="eg: 13:9"></td>
                ${playerInputs.replace('team_a', 'team_a').replace('team_b', 'team_b')} 
                <td class="actions"></td>`;
            tr.querySelector('.actions').appendChild(createDeleteButton());
            return tr;
        },
        'schedule-table-body': () => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><select data-col="group">${groupOptions}</select></td>
                <td><select data-col="match_id">${scheduleMatchIdOptions}</select></td>
                <td><input type="text" data-col="team_a" placeholder="队伍A"></td>
                <td><input type="text" data-col="team_b" placeholder="队伍B"></td>
                <td><input type="number" data-col="score_a" placeholder="得分"></td>
                <td><input type="number" data-col="score_b" placeholder="得分"></td>
                <td><input type="text" data-col="link" placeholder="https://..."></td>
                <td class="actions"></td>`;
            tr.querySelector('.actions').appendChild(createDeleteButton());
            return tr;
        },
        'ids-table-body': (isNew = true, data = { id: '', name: '' }) => {
            const tr = document.createElement('tr');
            tr.dataset.isNew = isNew;
            tr.innerHTML = `
                <td><input type="text" data-col="id" value="${data.id}" ${!isNew ? 'readonly' : ''}></td>
                <td><input type="text" data-col="name" value="${data.name}"></td>
                <td class="actions"></td>`;
            tr.querySelector('.actions').appendChild(createDeleteButton());
            return tr;
        }
    };

    function setupDynamicRows() {
        document.querySelectorAll('.add-row-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tableBodyId = btn.dataset.table;
                const tableBody = document.getElementById(tableBodyId);
                const newRow = rowTemplates[tableBodyId]();
                tableBody.appendChild(newRow);
            });
        });
    }

    // --- 数据提交逻辑 ---
    function getTableData(tableBodyId) {
        const rows = document.querySelectorAll(`#${tableBodyId} tr`);
        const data = [];
        rows.forEach(row => {
            const rowData = {};
            row.querySelectorAll('input, select').forEach(input => {
                if (input.dataset.col) {
                    rowData[input.dataset.col] = input.type === 'number' ? (input.value ? parseInt(input.value) : null) : input.value;
                }
            });
            // 补充额外信息用于更新
            if (row.dataset.isNew !== undefined) rowData.isNew = row.dataset.isNew === 'true';
            if (Object.keys(rowData).length > 0) data.push(rowData);
        });
        return data;
    }

    async function submitMatches() {
        const data = getTableData('matches-table-body');
        if (data.length === 0) return alert('没有要提交的数据。');
        
        // 简单验证
        for (const row of data) {
            if (!row.group || !row.stage || !row.team_a || !row.team_b) {
                return alert('请确保每行的组别、赛段和队伍名都已填写！');
            }
        }

        const { error } = await supabaseClient.from('matches').insert(data);
        if (error) {
            alert('提交赛果失败: ' + error.message);
        } else {
            alert('赛果提交成功！');
            document.getElementById('matches-table-body').innerHTML = '';
        }
    }

    async function submitSchedule() {
        const data = getTableData('schedule-table-body');
        if (data.length === 0) return alert('没有要提交的数据。');

        const { error } = await supabaseClient.from('match_schedule').insert(data);
        if (error) {
            alert('提交赛程失败: ' + error.message);
        } else {
            alert('赛程提交成功！');
            document.getElementById('schedule-table-body').innerHTML = '';
        }
    }

    async function loadIdsData() {
        const tableBody = document.getElementById('ids-table-body');
        tableBody.innerHTML = '<tr><td colspan="3">正在加载...</td></tr>';
        const { data, error } = await supabaseClient.from('player_ids').select('*').order('id');
        if (error) {
            tableBody.innerHTML = `<tr><td colspan="3">加载失败: ${error.message}</td></tr>`;
            return;
        }
        tableBody.innerHTML = '';
        data.forEach(player => {
            const row = rowTemplates['ids-table-body'](false, player);
            tableBody.appendChild(row);
        });
    }

    async function updateIds() {
        const data = getTableData('ids-table-body');
        if (data.length === 0) return alert('没有要更新的数据。');
        
        // 验证主键不能为空
        for (const row of data) {
            if (!row.id) return alert('选手ID为主键，不能为空！');
        }

        // upsert 用于 "update or insert"
        const { error } = await supabaseClient.from('player_ids').upsert(data);
        if (error) {
            alert('更新失败: ' + error.message);
        } else {
            alert('选手ID更新成功！');
            loadIdsData(); // 重新加载数据
        }
    }
});
</script>
</body>
</html>