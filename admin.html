<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #D64550;
            --bg-color: rgba(15, 25, 35, 0.85);
            --text-color: #ece8e1;
            --card-bg-color: rgba(26, 40, 54, 0.8);
            --header-bg-color: rgba(26, 40, 54, 0.85);
            --border-color: #2a3a49;
            --success-color: #4CAF50;
            --shadow-color: rgba(0,0,0,0.3);
            --control-height: 42px;
        }
        body.light-theme {
            --primary-color: #D64550;
            --bg-color: rgba(240, 242, 245, 0.85);
            --text-color: #1c1e21;
            --card-bg-color: rgba(255, 255, 255, 0.8);
            --header-bg-color: rgba(255, 255, 255, 0.85);
            --border-color: #dadde1;
            --shadow-color: rgba(0,0,0,0.1);
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px 0;
            background-image: url('https://cdnb.artstation.com/p/assets/images/images/053/266/803/large/cai-husband-champions-2022-rev01.jpg?1661819637');
            background-attachment: fixed;
            background-size: cover;
        }
        .container { width: 95%; max-width: 1600px; margin: 0 auto; }
        .main-header-block {
            background-color: var(--header-bg-color);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 16px var(--shadow-color);
            text-align: center;
            margin-bottom: 40px;
            border: 1px solid var(--border-color);
            position: relative;
        }
        .main-header-block h1 { color: var(--primary-color); margin: 0 0 10px 0; font-weight: 700; font-size: 2.5em; }
        .controls-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
        }
        .filter-group, .nav-button {
            height: var(--control-height);
            display: inline-flex;
            align-items: center;
            border-radius: 8px;
            font-weight: 500;
        }
        .filter-group { background-color: var(--card-bg-color); padding: 5px; border: 1px solid var(--border-color); }
        .filter-group button {
            padding: 0 15px;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            opacity: 0.7;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9em;
            height: 100%;
            transition: background-color 0.3s, color 0.3s;
        }
        .filter-group button.active { background-color: var(--primary-color); color: white; opacity: 1; }
        .nav-button {
            padding: 0 25px;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            text-decoration: none;
            transition: background-color 0.3s, color 0.3s;
        }
        .nav-button:hover { background-color: var(--primary-color); color: white; }
        .top-right-controls { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 15px; }
        #theme-text { font-size: 0.8em; opacity: 0.8; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { background-color: var(--border-color); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: var(--text-color); bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(24px); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-section, .table-section {
            background-color: var(--card-bg-color);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
            margin-top: 2rem;
        }
        .form-section h3, .table-section h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; border: 1px solid var(--border-color); text-align: left; }
        thead th { background-color: rgba(214, 69, 80, 0.2); white-space: nowrap; }

        input, select {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
            min-width: 60px;
        }
        td.actions { text-align: center; }
        button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button.success { background-color: var(--success-color); }
        .add-row-btn { margin-bottom: 1rem; }
        .delete-row-btn { background-color: #7f8c8d; }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px);
            z-index: 1000; display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--card-bg-color);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 12px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #password-input { font-size: 1.2em; text-align: center; margin: 1rem 0; }
        .match-record { border-bottom: 3px solid var(--primary-color); margin-bottom: 1rem; padding-bottom: 1rem;}
        .match-record:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <datalist id="teams-datalist"></datalist>

    <div id="password-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2>请输入管理口令</h2>
            <input type="password" id="password-input" autofocus>
            <button id="password-submit">进入</button>
        </div>
    </div>

    <div id="admin-panel" class="container" style="display: none;">
        <header class="main-header-block">
             <div class="top-right-controls">
                <span id="theme-text"></span>
                <label class="theme-switch">
                    <input type="checkbox" id="theme-toggle-checkbox">
                    <span class="slider"></span>
                </label>
            </div>
            <h1>管理后台</h1>
            <div class="controls-container">
                 <div class="filter-group" id="group-filter-buttons">
                    <button class="active" data-group="传奇组">传奇组</button>
                    <button data-group="中坚组">中坚组</button>
                    <button data-group="挑战组">挑战组</button>
                </div>
            </div>
            <div class="controls-container">
                <a href="index.html" class="nav-button">返回比赛中心</a>
                <a href="summary.html" class="nav-button">查看选手数据</a>
            </div>
            <div class="controls-container">
                <div class="filter-group" id="tab-filters">
                    <button class="active" data-tab="matches-tab">赛果管理</button>
                    <button data-tab="schedule-tab">赛程管理</button>
                    <button data-tab="ids-tab">ID 维护</button>
                </div>
            </div>
        </header>

        <div id="matches-tab" class="tab-content active">
            <div class="form-section">
                <h3>新增赛果</h3>
                <button class="add-row-btn" data-table="matches-table-body">新增记录</button>
                <div id="matches-form-container"></div>
                <button class="success" style="margin-top: 1rem;" id="submit-matches">提交赛果</button>
            </div>
        </div>

        <div id="schedule-tab" class="tab-content">
            <div class="form-section">
                <h3>新增赛程</h3>
                <button class="add-row-btn" data-table="schedule-table-body">新增记录</button>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr><th>比赛ID</th><th>队伍A</th><th>队伍B</th><th>A队得分</th><th>B队得分</th><th>回放链接</th><th>操作</th></tr>
                        </thead>
                        <tbody id="schedule-table-body"></tbody>
                    </table>
                </div>
                <button class="success" style="margin-top: 1rem;" id="submit-schedule">提交赛程</button>
            </div>
        </div>

        <div id="ids-tab" class="tab-content">
             <div class="table-section">
                <h3>选手 ID 与荣誉维护</h3>
                <button class="add-row-btn" data-table="ids-table-body">新增记录</button>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr><th>选手 ID (主键)</th><th>选手真名</th><th>组别</th><th>所属队伍</th><th>头像链接</th><th>选手荣誉 (用"、"分割)</th><th>操作</th></tr>
                        </thead>
                        <tbody id="ids-table-body"></tbody>
                    </table>
                </div>
                <button class="success" style="margin-top: 1rem;" id="update-ids">更新/添加 ID</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SUPABASE_URL = 'https://vbyvolmtkjjyeiibpljf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZieXZvbG10a2pqeWVpaWJwbGpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NzMxNDksImV4cCI6MjA3MjI0OTE0OX0.Tnot1kIVn8vJ-vggYaTGBGTkIBY7m6yIOquSjG5mSUM';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    const passwordModal = document.getElementById('password-modal');
    const adminPanel = document.getElementById('admin-panel');
    const passwordInput = document.getElementById('password-input');
    const passwordSubmit = document.getElementById('password-submit');

    let allPlayersData = [];
    let groupData = { '传奇组': { teams: new Set(), rosters: {} }, '中坚组': { teams: new Set(), rosters: {} }, '挑战组': { teams: new Set(), rosters: {} } };

    async function checkPassword() {
        const inputPassword = passwordInput.value;
        if (!inputPassword) { alert('请输入口令！'); return; }
        try {
            const { data, error } = await supabaseClient.from('manage').select('password').limit(1).single();
            if (error) throw error;
            if (data && data.password === inputPassword) {
                passwordModal.style.display = 'none';
                adminPanel.style.display = 'block';
                initializeAdminPanel();
            } else {
                alert('口令错误！');
            }
        } catch (error) {
            console.error('验证口令时出错:', error);
            alert('验证失败，请检查数据库连接和表设置。');
        }
    }
    passwordSubmit.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkPassword(); });

    async function initializeAdminPanel() {
        await loadInitialData();
        setupThemeToggle();
        setupTabs();
        setupDynamicRows();
        setupGroupFilters();
        loadIdsData();
        document.getElementById('submit-matches').addEventListener('click', submitMatches);
        document.getElementById('submit-schedule').addEventListener('click', submitSchedule);
        document.getElementById('update-ids').addEventListener('click', updateIds);
    }
    
    async function loadInitialData() {
        const { data, error } = await supabaseClient.from('player_ids').select('id, name, team, "group"');
        if (error) { console.error('无法加载选手数据:', error); return; }
        
        allPlayersData = data;
        groupData = { '传奇组': { teams: new Set(), rosters: {} }, '中坚组': { teams: new Set(), rosters: {} }, '挑战组': { teams: new Set(), rosters: {} } };

        data.forEach(player => {
            const playerGroup = player.group || '传奇组'; // Default to a group if null
            if (groupData[playerGroup]) {
                if (player.team) {
                    groupData[playerGroup].teams.add(player.team);
                    if (!groupData[playerGroup].rosters[player.team]) {
                        groupData[playerGroup].rosters[player.team] = [];
                    }
                    groupData[playerGroup].rosters[player.team].push({ id: player.id, name: player.name });
                }
            }
        });
        updateTeamDatalist();
    }

    function updateTeamDatalist() {
        const allTeams = new Set();
        Object.values(groupData).forEach(data => {
            data.teams.forEach(team => allTeams.add(team));
        });
        const teamDatalistHTML = [...allTeams].sort().map(t => `<option value="${t}"></option>`).join('');
        document.getElementById('teams-datalist').innerHTML = teamDatalistHTML;
    }

    function getCurrentGroup() {
        return document.querySelector('#group-filter-buttons button.active').dataset.group;
    }
    
    function getTeamOptionsHTMLForCurrentGroup() {
        const currentGroup = getCurrentGroup();
        const teams = groupData[currentGroup] ? [...groupData[currentGroup].teams].sort() : [];
        return '<option value="">选择队伍</option>' + teams.map(t => `<option value="${t}">${t}</option>`).join('');
    }

    function setupGroupFilters() {
        const groupFilterButtons = document.getElementById('group-filter-buttons');
        groupFilterButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
                groupFilterButtons.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
            }
        });
    }

    function setupThemeToggle() {
        const themeToggle = document.getElementById('theme-toggle-checkbox');
        const themeText = document.getElementById('theme-text');
        function setTheme(isLight) {
            document.body.classList.toggle('light-theme', isLight);
            themeToggle.checked = isLight;
            themeText.textContent = isLight ? '点击切换夜间模式' : '点击切换日间模式';
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }
        const savedTheme = localStorage.getItem('theme');
        setTheme((savedTheme === null) ? true : (savedTheme === 'dark'));
        themeToggle.addEventListener('change', (e) => setTheme(e.target.checked));
    }

    function setupTabs() {
        const tabFilters = document.getElementById('tab-filters');
        const tabContents = document.querySelectorAll('.tab-content');
        tabFilters.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
                tabFilters.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                const tabId = e.target.dataset.tab;
                tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === tabId);
                });
            }
        });
    }

    const stageOptions = `<option value="小组赛">小组赛</option><option value="淘汰赛第一轮">淘汰赛第一轮</option><option value="胜者组决赛">胜者组决赛</option><option value="败者组第一轮">败者组第一轮</option><option value="败者组决赛">败者组决赛</option><option value="决赛">决赛</option>`;
    const characterOptions = ['幻棱','钛狐','维斯','暮蝶','壹决','不死鸟','捷风','蝰蛇','雷兹','炼狱','猎枭','奇乐','芮娜','铁臂','贤者','幽影','尚勃勒','斯凯','霓虹','夜露','海神','星礈','盖可','钢锁','黑梦'].map(c => `<option value="${c}">${c}</option>`).join('');
    const mapOptions = ['源工重镇', '隐世修所', '霓虹町', '亚海悬城', '森寒冬港', '微风岛屿', '莲华古城', '裂变峡谷', '深海明珠', '盐海矿镇'].map(m => `<option value="${m}">${m}</option>`).join('');
    const scheduleMatchIdOptions = `<option value="S1-1">S1-1</option><option value="S1-2">S1-2</option><option value="S1-3">S1-3</option><option value="S1-4">S1-4</option><option value="S2-1W">S2-1W</option><option value="S2-2W">S2-2W</option><option value="S2-1L">S2-1L</option><option value="S2-2L">S2-2L</option><option value="S3-1M">S3-1M</option><option value="S3-2M">S3-2M</option><option value="P-WB1-1">P-WB1-1</option><option value="P-WB1-2">P-WB1-2</option><option value="P-WBF">P-WBF</option><option value="P-LB1">P-LB1</option><option value="P-LBF">P-LBF</option><option value="P-GF">P-GF</option>`;
    const groupOptionsHTML = `<option value="传奇组">传奇组</option><option value="中坚组">中坚组</option><option value="挑战组">挑战组</option>`;

    function createDeleteButton(recordElement) {
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '删除该记录';
        deleteBtn.className = 'delete-row-btn';
        deleteBtn.onclick = () => recordElement.remove();
        return deleteBtn;
    }

    const rowTemplates = {
        'matches-table-body': () => {
            const recordDiv = document.createElement('div');
            recordDiv.className = 'match-record';
            
            let commonInputs = `
                <div style="overflow-x:auto;"><table style="width:100%; margin-bottom:1rem;">
                    <tr>
                        <td><strong>赛段:</strong> <select data-col="stage">${stageOptions}</select></td>
                        <td><strong>日期:</strong> <input type="date" data-col="match_date"></td>
                        <td><strong>地图:</strong> <select data-col="map">${mapOptions}</select></td>
                        <td><strong>比分:</strong> <input type="text" data-col="score" placeholder="eg: 13:9"></td>
                    </tr>
                </table></div>`;

            let teamA_Inputs = createTeamTable('A');
            let teamB_Inputs = createTeamTable('B');
            
            recordDiv.innerHTML = commonInputs + teamA_Inputs + teamB_Inputs;
            const deleteContainer = document.createElement('div');
            deleteContainer.style.textAlign = 'right';
            deleteContainer.style.padding = '10px';
            deleteContainer.appendChild(createDeleteButton(recordDiv));
            recordDiv.appendChild(deleteContainer);
            
            return recordDiv;
        },
        'schedule-table-body': () => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><select data-col="match_id">${scheduleMatchIdOptions}</select></td>
                <td><select data-col="team_a">${getTeamOptionsHTMLForCurrentGroup()}</select></td>
                <td><select data-col="team_b">${getTeamOptionsHTMLForCurrentGroup()}</select></td>
                <td><input type="number" data-col="score_a" placeholder="得分"></td>
                <td><input type="number" data-col="score_b" placeholder="得分"></td>
                <td><input type="text" data-col="link" placeholder="https://..."></td>
                <td class="actions"></td>`;
            tr.querySelector('.actions').appendChild(createDeleteButton(tr));
            return tr;
        },
        'ids-table-body': (isNew = true, data = { id: '', name: '', group: '', team: '', image: '', honor: '' }) => {
            const tr = document.createElement('tr');
            tr.dataset.isNew = isNew;
            tr.innerHTML = `
                <td><input type="text" data-col="id" value="${data.id || ''}" ${!isNew ? 'readonly' : ''}></td>
                <td><input type="text" data-col="name" value="${data.name || ''}"></td>
                <td><select data-col="group">${groupOptionsHTML}</select></td>
                <td><input type="text" data-col="team" value="${data.team || ''}" list="teams-datalist"></td>
                <td><input type="text" data-col="image" value="${data.image || ''}"></td>
                <td><input type="text" data-col="honor" value="${data.honor || ''}"></td>
                <td class="actions"></td>`;
            tr.querySelector('.actions').appendChild(createDeleteButton(tr));
            if(data.group) tr.querySelector('select[data-col="group"]').value = data.group;
            return tr;
        }
    };
    
    function createTeamTable(teamLabel) {
        const teamKey = `team_${teamLabel.toLowerCase()}`;
        const datalistId = `team-${teamLabel.toLowerCase()}-players-datalist`;
        let table = `<div style="overflow-x:auto;"><table style="width:100%; margin-bottom: 1rem;">
            <thead>
                <tr>
                    <th>队伍 ${teamLabel}</th>
                    <th>选手 ID</th><th>角色</th>
                    <th>ACS</th><th>K</th><th>D</th><th>A</th>
                </tr>
            </thead>
            <tbody>
                 <tr>
                    <td rowspan="5" style="vertical-align: middle;"><select data-col="${teamKey}" class="team-selector">${getTeamOptionsHTMLForCurrentGroup()}</select></td>
                    ${Array(5).fill(0).map((_, i) => `
                        ${i > 0 ? '<tr>' : ''}
                        <td><input type="text" data-col="${teamKey}_player${i+1}_id" placeholder="ID/选择" list="${datalistId}"></td>
                        <td><select data-col="${teamKey}_player${i+1}_ch">${characterOptions}</select></td>
                        <td><input type="number" data-col="${teamKey}_player${i+1}_acs" placeholder="ACS"></td>
                        <td><input type="number" data-col="${teamKey}_player${i+1}_k" placeholder="K"></td>
                        <td><input type="number" data-col="${teamKey}_player${i+1}_d" placeholder="D"></td>
                        <td><input type="number" data-col="${teamKey}_player${i+1}_a" placeholder="A"></td>
                        ${i > 0 ? '</tr>' : ''}
                    `).join('')}
                </tr>
            </tbody>
        </table></div>`;
        return table;
    }
    
    document.getElementById('matches-form-container').addEventListener('change', function(e) {
        if (e.target.classList.contains('team-selector')) {
            const selectedTeam = e.target.value;
            const currentGroup = getCurrentGroup();
            const roster = groupData[currentGroup]?.rosters[selectedTeam] || [];
            
            const teamLabel = e.target.dataset.col === 'team_a' ? 'a' : 'b';
            const datalistId = `team-${teamLabel}-players-datalist`;
            
            const datalist = document.getElementById(datalistId) || document.createElement('datalist');
            datalist.id = datalistId;
            datalist.innerHTML = roster.map(p => `<option value="${p.id}"></option>`).join('');
            if (!document.getElementById(datalistId)) document.body.appendChild(datalist);

            const table = e.target.closest('table');
            const idInputs = table.querySelectorAll(`input[data-col^="team_${teamLabel}_player"]`);
            idInputs.forEach((input, index) => {
                input.value = roster[index] ? roster[index].id : '';
            });
        }
    });

    function setupDynamicRows() {
        document.querySelectorAll('.add-row-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tableId = btn.dataset.table;
                let container;
                if (tableId === 'matches-table-body') {
                    container = document.getElementById('matches-form-container');
                     const newRecord = rowTemplates['matches-table-body']();
                    container.appendChild(newRecord);
                } else {
                    container = document.getElementById(tableId);
                     const newRow = rowTemplates[tableId]();
                    container.appendChild(newRow);
                }
            });
        });
    }

    function getTableData(containerId, isIdsTable = false) {
        let rows;
        if (containerId === 'matches-form-container') {
            rows = document.querySelectorAll(`#${containerId} .match-record`);
        } else {
            rows = document.querySelectorAll(`#${containerId} tr`);
        }

        const data = [];
        const selectedGroup = getCurrentGroup();

        rows.forEach(row => {
            const rowData = {};
            if (isIdsTable) {
                rowData.isNew = row.dataset.isNew === 'true';
            }
             if (containerId !== 'ids-table-body') {
                 rowData.group = selectedGroup;
             }

            row.querySelectorAll('input, select').forEach(input => {
                if (input.dataset.col) {
                    let value = input.value.trim();
                    if (value !== '' && value !== null) {
                         if (input.type === 'number') value = parseFloat(value);
                         rowData[input.dataset.col] = value;
                    }
                }
            });
            if (Object.keys(rowData).length > (isIdsTable ? 1 : 1)) data.push(rowData);
        });
        return data;
    }

    async function submitMatches() {
        const data = getTableData('matches-form-container');
        if (data.length === 0) return alert('没有要提交的数据。');

        const processedData = data.map(row => {
            const newRow = { ...row };
            ['a', 'b'].forEach(teamLabel => {
                for (let i = 1; i <= 5; i++) {
                    const prefix = `team_${teamLabel}_player${i}`;
                    const acs = newRow[`${prefix}_acs`];
                    const k = newRow[`${prefix}_k`];
                    const d = newRow[`${prefix}_d`];
                    const a = newRow[`${prefix}_a`];

                    if (newRow[`${prefix}_id`] && acs !== undefined && k !== undefined && d !== undefined && a !== undefined) {
                        newRow[`${prefix}_data`] = `${acs}/${k}/${d}/${a}`;
                    }
                    delete newRow[`${prefix}_acs`];
                    delete newRow[`${prefix}_k`];
                    delete newRow[`${prefix}_d`];
                    delete newRow[`${prefix}_a`];
                }
            });
            return newRow;
        });

        for (const row of processedData) {
            if (!row.group || !row.stage || !row.team_a || !row.team_b) return alert('请确保每条记录的赛段和队伍名都已填写！');
        }

        const { error } = await supabaseClient.from('matches').insert(processedData);
        if (error) { alert('提交赛果失败: ' + error.message); console.error(error); }
        else { alert('赛果提交成功！'); document.getElementById('matches-form-container').innerHTML = ''; }
    }

    async function submitSchedule() {
        const data = getTableData('schedule-table-body');
        if (data.length === 0) return alert('没有要提交的数据。');
        const { error } = await supabaseClient.from('match_schedule').upsert(data, { onConflict: 'group, match_id' });
        if (error) { alert('提交赛程失败: ' + error.message); }
        else { alert('赛程提交/更新成功！'); document.getElementById('schedule-table-body').innerHTML = ''; }
    }

    async function loadIdsData() {
        const tableBody = document.getElementById('ids-table-body');
        tableBody.innerHTML = '<tr><td colspan="7">正在加载...</td></tr>';
        const { data, error } = await supabaseClient.from('player_ids').select('*').order('id');
        if (error) { tableBody.innerHTML = `<tr><td colspan="7">加载失败: ${error.message}</td></tr>`; return; }
        tableBody.innerHTML = '';
        data.forEach(player => tableBody.appendChild(rowTemplates['ids-table-body'](false, player)));
    }

    async function updateIds() {
        const dataToUpsert = getTableData('ids-table-body', true).map(row => {
            const { isNew, ...dbRow } = row;
            return dbRow;
        });

        if (dataToUpsert.length === 0) return alert('没有要更新的数据。');
        
        for (const row of dataToUpsert) { 
            if (!row.id) return alert('选手ID为主键，不能为空！'); 
        }
        
        const { error } = await supabaseClient.from('player_ids').upsert(dataToUpsert);

        if (error) { 
            alert('更新失败: ' + error.message); 
            console.error(error);
        } else { 
            alert('选手ID更新成功！'); 
            await loadInitialData();
            loadIdsData(); 
        }
    }
});
</script>
</body>
</html>