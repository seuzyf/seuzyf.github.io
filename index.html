<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HWVCTS4 - 比赛中心</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #D64550;
            --bg-color: rgba(15, 25, 35, 0.85);
            --text-color: #ece8e1;
            --card-bg-color: rgba(26, 40, 54, 0.8);
            --header-bg-color: rgba(26, 40, 54, 0.85);
            --border-color: #2a3a49;
            --gold-color: #ffd700;
            --shadow-color: rgba(0,0,0,0.3);
            --control-height: 42px;
            --group-stage-bg: rgba(83, 104, 126, 0.2);
            --playoff-stage-bg: rgba(74, 144, 226, 0.2);
            --final-stage-bg: rgba(255, 215, 0, 0.15);
            --win-color: #4CAF50;
            --loss-color: #F44336;
        }
        body.light-theme {
            --primary-color: #D64550;
            --bg-color: rgba(240, 242, 245, 0.85);
            --text-color: #1c1e21;
            --card-bg-color: rgba(255, 255, 255, 0.8);
            --header-bg-color: rgba(255, 255, 255, 0.85);
            --border-color: #dadde1;
            --shadow-color: rgba(0,0,0,0.1);
            --group-stage-bg: rgba(83, 104, 126, 0.1);
            --playoff-stage-bg: rgba(74, 144, 226, 0.1);
            --final-stage-bg: rgba(255, 215, 0, 0.1);
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px 0;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            background-image: url('https://cdna.artstation.com/p/assets/images/images/077/456/776/4k/envar-studio-valorant-homepage-illustration-04.jpg?1719495121');
            background-attachment: fixed;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
        }
        .container { width: 90%; max-width: 1400px; margin: 0 auto; }
        
        .main-header-block {
            background-color: var(--header-bg-color);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 16px var(--shadow-color);
            text-align: center;
            margin-bottom: 40px;
            border: 1px solid var(--border-color);
            position: relative;
        }
        .main-header-block h1 { color: var(--primary-color); margin: 0 0 10px 0; font-weight: 700; font-size: 2.5em; }
        .controls-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
        }
        .filter-group, .nav-button {
            height: var(--control-height);
            display: inline-flex;
            align-items: center;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .filter-group { background-color: var(--card-bg-color); padding: 5px; border: 1px solid var(--border-color); }
        .filter-group button { padding: 0 15px; border: none; background-color: transparent; color: var(--text-color); opacity: 0.7; cursor: pointer; border-radius: 6px; font-size: 0.9em; height: 100%; }
        .filter-group button.active { background-color: var(--primary-color); color: white; opacity: 1; }
        .nav-button { padding: 0 25px; border: 2px solid var(--primary-color); color: var(--primary-color); text-decoration: none; }
        .nav-button:hover { background-color: var(--primary-color); color: white; }
        
        .content-block {
            background-color: var(--card-bg-color);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 16px var(--shadow-color);
            margin-bottom: 40px;
        }
        .content-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 25px;
        }
        .content-block-header h2 {
            font-size: 2em;
            color: var(--primary-color);
            margin: 0;
            padding: 0;
            border: none;
        }
        .header-controls { display: flex; align-items: center; gap: 12px; font-size: 0.9em; }
        .merge-stats-switch { display: flex; align-items: center; gap: 8px; }
        .merge-stats-switch .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .merge-stats-switch .switch input { opacity: 0; width: 0; height: 0; }
        .merge-stats-switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 22px; }
        .merge-stats-switch .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: var(--text-color); transition: .4s; border-radius: 50%; }
        .merge-stats-switch input:checked + .slider { background-color: var(--primary-color); }
        .merge-stats-switch input:checked + .slider:before { transform: translateX(18px); }
        .tooltip { position: relative; display: flex; align-items: center; cursor: help; }
        .tooltip .tooltip-icon { font-weight: bold; color: #aaa; border: 1px solid #aaa; border-radius: 50%; width: 18px; height: 18px; display: inline-flex; justify-content: center; align-items: center; line-height: 1; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 8px; position: absolute; z-index: 10; bottom: 150%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.85em; font-weight: 400; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }


        #matches-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .match-card {
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            position: relative;
        }
        .match-card.stage-小组赛 { background-color: var(--group-stage-bg); }
        .match-card.stage-淘汰赛 { background-color: var(--playoff-stage-bg); }
        .match-card.stage-is-final { background-color: var(--final-stage-bg); border: 1px solid var(--gold-color); }
        
        .match-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px var(--shadow-color); }
        .match-header { display: flex; flex-direction: column; padding: 15px; }
        .match-card::after {
            content: attr(data-stage-name);
            position: absolute; top: 0; right: 0; padding: 4px 12px;
            border-bottom-left-radius: 12px;
            font-size: 0.8em; font-weight: 500; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 5;
        }
        .stage-小组赛::after { background-color: #53687E; }
        .stage-淘汰赛::after { background-color: #4A90E2; }
        .stage-is-final::after { background-image: linear-gradient(135deg, #e4c400, #b48600); color: #0f1923; }
        
        .match-meta {
            display: flex;
            justify-content: flex-start;
            align-items: baseline;
            width: 100%;
            margin-bottom: 10px;
            gap: 15px;
        }
        .match-meta .map { font-weight: 500; font-size: 1.2em; }
        .match-meta .date { font-size: 0.8em; opacity: 0.8; }
        .match-teams { display: flex; justify-content: space-between; align-items: center; width: 100%; font-size: 1.3em; font-weight: bold; }
        .team-name { flex: 1; text-align: center; }
        .score { color: var(--primary-color); padding: 0 15px; }
        
        #standings-table { width: 100%; border-collapse: collapse; }
        #standings-table thead { background-color: var(--primary-color); color: white; }
        #standings-table th, #standings-table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        #standings-table tbody tr:last-child td { border-bottom: none; }
        #standings-table tbody tr:hover { background-color: rgba(255, 255, 255, 0.05); }
        #standings-table td:first-child, #standings-table th:first-child { text-align: center; }
        .team-name-cell { color: var(--primary-color); font-weight: bold; cursor: pointer; }
        .team-name-cell:hover { text-decoration: underline; }

        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            z-index: 1000; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-backdrop.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--card-bg-color);
            border-radius: 12px; border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 90%; max-width: 1100px; max-height: 90vh;
            overflow-y: auto; transform: scale(0.9); transition: transform 0.3s;
            padding: 20px 30px;
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .modal-header { font-size: 1.8em; color: var(--primary-color); margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .roster-list { list-style: none; padding: 0; font-size: 1.2em; }
        .roster-list li { padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .roster-list li:last-child { border-bottom: none; }
        .roster-list .sub-label { color: var(--primary-color); font-size: 0.8em; margin-left: 8px; }
        .player-comparison-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .player-comparison-table th, .player-comparison-table td { padding: 10px 8px; text-align: center; border-bottom: 1px solid var(--border-color); white-space: normal; }
        .player-comparison-table thead th { padding: 12px 8px; vertical-align: middle; white-space: nowrap; }
        .player-comparison-table tbody tr:last-child td { border-bottom: none; }
        .player-comparison-table .team-name-header { font-size: 1.4em; }
        .player-comparison-table .score-details { font-size: 1em; font-weight: 500; padding: 0; }
        .score-details .score-line { display: flex; justify-content: center; align-items: center; gap: 8px; padding: 2px 0; }
        .score-details .score-map { opacity: 0.8; font-size: 0.9em; }
        .score-win { color: var(--win-color); }
        .score-loss { color: var(--loss-color); }
        .player-comparison-table .stat-header th { font-size: 0.9em; }
        .player-comparison-table td.player-id-cell { text-align: left; }
        .player-id-cell .player-id { font-weight: 500; }
        .player-id-cell .player-name { font-size: 0.9em; opacity: 0.8; }
        .player-comparison-table td.player-acs { font-weight: bold; color: var(--primary-color); }
        .player-comparison-table .separator { width: 1px; padding: 0; }
        
        .top-right-controls { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 15px; }
        #theme-text { font-size: 0.8em; opacity: 0.8; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { background-color: var(--border-color); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: var(--text-color); bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(24px); }
        #admin-btn {
            background: none; border: none; cursor: pointer; color: var(--text-color);
            opacity: 0.7; transition: opacity 0.2s;
            display: flex;
            align-items: center;
        }
        #admin-btn:hover { opacity: 1; }
        #admin-btn svg { width: 24px; height: 24px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-header-block">
            <div class="top-right-controls">
                <span id="theme-text"></span>
                <label class="theme-switch">
                    <input type="checkbox" id="theme-toggle-checkbox">
                    <span class="slider"></span>
                </label>
                <a href="admin.html" id="admin-btn" title="管理后台">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.8298 12.1741C19.9363 11.6963 19.9363 11.1963 19.8298 10.7185L21.6569 9.28148C21.8617 9.1237 21.9213 8.84815 21.8024 8.62222L20.0445 5.37778C19.9256 5.15185 19.6582 5.06667 19.4445 5.17037L17.2223 6.0963C16.6371 5.65185 15.9927 5.2963 15.3038 5.03704L14.9334 2.62222C14.9067 2.41481 14.7334 2.25185 14.526 2.25185H10.4741C10.2667 2.25185 10.0934 2.41481 10.0667 2.62222L9.6963 5.03704C8.99824 5.30519 8.36223 5.65185 7.77788 6.0963L5.55565 5.17037C5.34195 5.06667 5.07454 5.15185 4.95565 5.37778L3.19778 8.62222C3.07889 8.84815 3.13843 9.1237 3.34324 9.28148L5.17048 10.7185C5.06399 11.1963 5.06399 11.6963 5.17048 12.1741L3.34324 13.6111C3.13843 13.7689 3.07889 14.0444 3.19778 14.2704L4.95565 17.5148C5.07454 17.7407 5.34195 17.8259 5.55565 17.7222L7.77788 16.7963C8.36223 17.2407 8.99824 17.587 9.6963 17.8552L10.0667 20.27C10.0934 20.4774 10.2667 20.6404 10.4741 20.6404H14.526C14.7334 20.6404 14.9067 20.4774 14.9334 20.27L15.3038 17.8552C15.9927 17.5959 16.6371 17.25 17.2223 16.7963L19.4445 17.7222C19.6582 17.8259 19.9256 17.7407 20.0445 17.5148L21.8024 14.2704C21.9213 14.0444 21.8617 13.7689 21.6569 13.6111L19.8298 12.1741ZM12.5 14.9404C10.8167 14.9404 9.44454 13.5681 9.44454 11.8848C9.44454 10.2015 10.8167 8.82926 12.5 8.82926C14.1834 8.82926 15.5556 10.2015 15.5556 11.8848C15.5556 13.5681 14.1834 14.9404 12.5 14.9404Z"></path></svg>
                </a>
            </div>
            <h1>HWVCTS4 比赛中心</h1>
            <div class="controls-container">
                <div class="control-group">
                    <div class="filter-group" id="group-filter-buttons">
                        <button class="active" data-group="传奇组">传奇组</button>
                        <button data-group="中坚组">中坚组</button>
                        <button data-group="挑战组">挑战组</button>
                    </div>
                </div>
                <div class="control-group">
                     <div class="filter-group" id="stage-filter-buttons">
                        <button class="active" data-stage="all">所有赛段</button>
                        <button data-stage="小组赛">小组赛</button>
                        <button data-stage="淘汰赛">淘汰赛</button>
                    </div>
                </div>
                <a href="summary.html" class="nav-button">查看选手数据</a>
                <a href="schedule.html" class="nav-button" target="_blank">查看赛程</a>
                <a href="betting.html" class="nav-button">赛事竞猜</a>
            </div>
        </div>

        <main>
            <section class="content-block">
                <div class="content-block-header">
                     <h2 id="standings-title">战队积分榜 - 传奇组</h2>
                </div>
                <div style="overflow-x: auto;">
                    <table id="standings-table">
                        <thead>
                            <tr><th>排名</th><th>队伍</th><th>胜场</th><th>负场</th><th>净胜分</th></tr>
                        </thead>
                        <tbody id="standings-table-body"></tbody>
                    </table>
                </div>
            </section>
            <section class="content-block">
                <div class="content-block-header">
                    <h2 id="matches-title">比赛结果 - 传奇组</h2>
                    <div class="header-controls">
                        <div class="merge-stats-switch">
                            <span>合并统计</span>
                            <label class="switch">
                                <input type="checkbox" id="merge-stats-checkbox">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="tooltip">
                           <span class="tooltip-icon">?</span>
                            <span class="tooltiptext">勾选后，点击比赛将自动合并相同日期、阶段和队伍间的多场比赛数据 (如BO3)，展示总战绩。</span>
                        </div>
                    </div>
                </div>
                <div id="matches-view"></div>
            </section>
        </main>
    </div>

    <div id="modal" class="modal-backdrop">
        <div class="modal-content" id="modal-content-body"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SUPABASE_URL = 'https://vbyvolmtkjjyeiibpljf.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZieXZvbG10a2pqeWVpaWJwbGpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NzMxNDksImV4cCI6MjA3MjI0OTE0OX0.Tnot1kIVn8vJ-vggYaTGBGTkIBY7m6yIOquSjG5mSUM';
            const { createClient } = supabase;
            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

            const matchesView = document.getElementById('matches-view');
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content-body');
            const standingsTableBody = document.getElementById('standings-table-body');
            const themeToggle = document.getElementById('theme-toggle-checkbox');
            const themeText = document.getElementById('theme-text');
            const groupFilterButtons = document.getElementById('group-filter-buttons');
            const stageFilterButtons = document.getElementById('stage-filter-buttons');
            const matchesTitle = document.getElementById('matches-title');
            const standingsTitle = document.getElementById('standings-title');
            const mergeStatsCheckbox = document.getElementById('merge-stats-checkbox');
            
            let allMatchesData = [];
            let allPlayersData = [];
            let idNameMap = {};

            function setTheme(isLight) {
                document.body.classList.toggle('light-theme', isLight);
                themeToggle.checked = isLight;
                themeText.textContent = isLight ? '点击切换夜间模式' : '点击切换日间模式';
                localStorage.setItem('theme', isLight ? 'light' : 'dark');
            }
            const savedTheme = localStorage.getItem('theme');
            setTheme((savedTheme === null) ? true : (savedTheme === 'light'));
            themeToggle.addEventListener('change', (e) => setTheme(e.target.checked));

            async function loadDataFromSupabase() {
                matchesView.innerHTML = '<p>正在从 Supabase 加载数据...</p>';
                try {
                    const [{ data: matches, error: matchesError }, { data: players, error: playersError }] = await Promise.all([
                        supabaseClient.from('matches').select('*'),
                        supabaseClient.from('player_ids').select('id, name, team, "group"')
                    ]);

                    if (matchesError || playersError) throw matchesError || playersError;

                    allMatchesData = matches;
                    allPlayersData = players;
                    idNameMap = players.reduce((map, p) => { map[p.id] = p.name; return map; }, {});
                    
                    localStorage.setItem('valorantPlayerSummary', JSON.stringify(processAllPlayerData(matches)));
                    localStorage.setItem('valorantIdNameMap', JSON.stringify(idNameMap));


                    document.querySelector('#group-filter-buttons button.active')?.classList.remove('active');
                    document.querySelector('#group-filter-buttons button[data-group="传奇组"]')?.classList.add('active');
                    updateDisplay();
                } catch (error) {
                    matchesView.innerHTML = `<p style="color:red;">数据加载失败: ${error.message}</p>`;
                }
            }
            loadDataFromSupabase();

            groupFilterButtons.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
                    groupFilterButtons.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    updateDisplay();
                }
            });
            stageFilterButtons.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
                    stageFilterButtons.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    updateDisplay();
                }
            });

            function updateDisplay() {
                const activeGroup = groupFilterButtons.querySelector('.active').dataset.group;
                const selectedStage = stageFilterButtons.querySelector('.active').dataset.stage;
                matchesTitle.textContent = `比赛结果 - ${activeGroup}`;
                standingsTitle.textContent = `战队积分榜 - ${activeGroup}`;
                
                const groupMatches = allMatchesData.filter(m => m.group === activeGroup);
                
                const filteredMatches = groupMatches.filter(match => 
                    selectedStage === 'all' || 
                    ((match.stage === '小组赛' ? '小组赛' : '淘汰赛') === selectedStage)
                );

                displayMatchCards(filteredMatches, groupMatches);
                calculateAndDisplayStandings(groupMatches);
            }
            
            function processAllPlayerData(matches) {
                const playerData = {};
                 matches.forEach(match => {
                    const score = String(match['score']).split(/[/:：]/).map(Number);
                    const totalRounds = (score.length === 2 && !isNaN(score[0]) && !isNaN(score[1])) ? (score[0] + score[1]) : 0;
                    ['team_a', 'team_b'].forEach(teamKey => {
                        const teamName = match[teamKey];
                        for (let p = 1; p <= 5; p++) {
                            const playerId = match[`${teamKey}_player${p}_id`];
                            const playerDataStr = match[`${teamKey}_player${p}_data`];
                            const playerCh = match[`${teamKey}_player${p}_ch`];
                            if (!playerId || !playerDataStr) continue;

                            const stats = String(playerDataStr).split('/').map(Number);
                            if (stats.length !== 4 || stats.some(isNaN)) continue;
                            
                            const uniquePlayerKey = `${playerId}::${match.group}`;
                            if (!playerData[uniquePlayerKey]) {
                                const registeredPlayer = allPlayersData.find(pl => pl.id === playerId);
                                playerData[uniquePlayerKey] = {
                                    id: playerId, group: match.group, 
                                    team: registeredPlayer ? registeredPlayer.team : teamName,
                                    total_stats: { kills: 0, deaths: 0, assists: 0, acs: 0, matchCount: 0, totalRounds: 0 },
                                    by_character: {}
                                };
                            }
                            
                            const playerEntry = playerData[uniquePlayerKey];
                            const p_stats = playerEntry.total_stats;
                            p_stats.acs += stats[0]; 
                            p_stats.kills += stats[1]; 
                            p_stats.deaths += stats[2]; 
                            p_stats.assists += stats[3];
                            p_stats.matchCount++; 
                            p_stats.totalRounds += totalRounds;

                            if (playerCh) {
                                const charName = String(playerCh).trim();
                                if (!playerEntry.by_character[charName]) {
                                    playerEntry.by_character[charName] = { kills: 0, deaths: 0, assists: 0, acs: 0, matchCount: 0, totalRounds: 0 };
                                }
                                const charStats = playerEntry.by_character[charName];
                                charStats.acs += stats[0]; 
                                charStats.kills += stats[1]; 
                                charStats.deaths += stats[2]; 
                                charStats.assists += stats[3];
                                charStats.matchCount++; 
                                charStats.totalRounds += totalRounds;
                            }
                        }
                    });
                });
                return playerData;
            }

            function displayMatchCards(matches, allGroupMatches) {
                matchesView.innerHTML = matches.length === 0 ? '<p>当前筛选条件下没有比赛。</p>' : '';
                matches.forEach(match => {
                    // Find the original index in the unfiltered group matches to maintain a stable reference
                    const originalIndex = allGroupMatches.findIndex(m => m.id === match.id);
                    createMatchCard(match, originalIndex);
                });
            }

            function calculateAndDisplayStandings(groupMatches) {
                const activeGroup = groupFilterButtons.querySelector('.active').dataset.group;
                const teamStandings = {};
                
                // Initialize all teams in the group from player_ids
                const teamsInGroup = new Set(allPlayersData.filter(p => p.group === activeGroup && p.team).map(p => p.team));
                teamsInGroup.forEach(teamName => {
                    teamStandings[teamName] = { wins: 0, losses: 0, roundDiff: 0 };
                });

                groupMatches.forEach(match => {
                    const [teamA, teamB] = [match.team_a, match.team_b];
                    if (!match.score) return;
                    const [scoreA, scoreB] = String(match.score).split(/[/:：]/).map(Number);
                    if (isNaN(scoreA) || isNaN(scoreB)) return;

                    // Ensure teams are initialized even if not in player_ids (e.g. older data)
                    if (!teamStandings[teamA]) teamStandings[teamA] = { wins: 0, losses: 0, roundDiff: 0 };
                    if (!teamStandings[teamB]) teamStandings[teamB] = { wins: 0, losses: 0, roundDiff: 0 };

                    if (scoreA > scoreB) { 
                        teamStandings[teamA].wins++; 
                        teamStandings[teamB].losses++; 
                    } else { 
                        teamStandings[teamB].wins++; 
                        teamStandings[teamA].losses++; 
                    }
                    teamStandings[teamA].roundDiff += (scoreA - scoreB);
                    teamStandings[teamB].roundDiff += (scoreB - scoreA);
                });
                
                const sortedTeams = Object.keys(teamStandings).sort((a, b) => 
                    teamStandings[b].wins - teamStandings[a].wins || 
                    teamStandings[b].roundDiff - teamStandings[a].roundDiff
                );

                standingsTableBody.innerHTML = sortedTeams.map((teamName, index) => {
                    const team = teamStandings[teamName];
                    return `<tr><td>${index + 1}</td><td class="team-name-cell" data-team="${teamName}">${teamName}</td><td>${team.wins}</td><td>${team.losses}</td><td>${team.roundDiff > 0 ? '+' : ''}${team.roundDiff}</td></tr>`;
                }).join('');
            }

            function createMatchCard(matchData, index) {
                const card = document.createElement('div');
                const stageType = (matchData.stage === '小组赛') ? '小组赛' : '淘汰赛';
                card.className = `match-card stage-${stageType} ${matchData.stage === '决赛' ? 'stage-is-final' : ''}`;
                card.dataset.stageName = matchData.stage;
                card.dataset.matchIndex = index;
                const score = String(matchData.score).replace(/[/：]/, ' : ');
                card.innerHTML = `
                    <div class="match-header">
                        <div class="match-meta">
                            <span class="map">${matchData.map}</span>
                            <span class="date">${matchData.match_date}</span>
                        </div>
                        <div class="match-teams">
                            <span class="team-name">${matchData.team_a}</span>
                            <span class="score">${score}</span>
                            <span class="team-name">${matchData.team_b}</span>
                        </div>
                    </div>
                `;
                matchesView.appendChild(card);
            }

            function showModalWithContent(htmlContent) {
                modalContent.innerHTML = htmlContent;
                modal.classList.add('visible');
            }
            
            function showMatchDetails(matches) {
                if (!Array.isArray(matches)) matches = [matches];
                const mainMatch = matches[0];
                const { team_a, team_b } = mainMatch;

                const combinedPlayerData = {};

                matches.forEach(match => {
                    const isReversed = match.team_a !== team_a;
                    ['team_a', 'team_b'].forEach((teamKey, teamIndex) => {
                        const currentTeamKey = isReversed ? (teamIndex === 0 ? 'team_b' : 'team_a') : teamKey;
                        const currentTeamName = match[currentTeamKey];
                        for (let p = 1; p <= 5; p++) {
                            const playerId = match[`${currentTeamKey}_player${p}_id`];
                            const playerDataStr = match[`${currentTeamKey}_player${p}_data`];
                            const playerCh = match[`${currentTeamKey}_player${p}_ch`];
                            if (!playerId || !playerDataStr) continue;

                            const stats = String(playerDataStr).split('/').map(Number);
                            if (stats.length !== 4 || stats.some(isNaN)) continue;

                            if (!combinedPlayerData[playerId]) {
                                combinedPlayerData[playerId] = { id: playerId, name: idNameMap[playerId] || '', team: currentTeamName, characters: new Set(), acs: 0, k: 0, d: 0, a: 0, count: 0, acsCount: 0 };
                            }
                            const pData = combinedPlayerData[playerId];
                            if (stats[0] > 0) {
                                pData.acs += stats[0];
                                pData.acsCount++;
                            }
                            pData.k += stats[1];
                            pData.d += stats[2];
                            pData.a += stats[3];
                            if (playerCh) pData.characters.add(playerCh);
                            pData.count++;
                        }
                    });
                });
                
                const teamAPlayers = Object.values(combinedPlayerData).filter(p => p.team === team_a);
                const teamBPlayers = Object.values(combinedPlayerData).filter(p => p.team === team_b);
                
                const finalTeamAPlayers = teamAPlayers.map(p => ({ ...p, acs: (p.acsCount > 0 ? p.acs / p.acsCount : 0).toFixed(0) })).sort((a, b) => b.acs - a.acs);
                const finalTeamBPlayers = teamBPlayers.map(p => ({ ...p, acs: (p.acsCount > 0 ? p.acs / p.acsCount : 0).toFixed(0) })).sort((a, b) => b.acs - a.acs);

                let rowsHTML = '';
                const maxPlayers = Math.max(finalTeamAPlayers.length, finalTeamBPlayers.length);
                const placeholder = { id: '-', name: '', characters: new Set(), acs: '-', k: '-', d: '-', a: '-', count: '-' };
                for (let i = 0; i < maxPlayers; i++) {
                    const pA = finalTeamAPlayers[i] || placeholder;
                    const pB = finalTeamBPlayers[i] || placeholder;
                    rowsHTML += `<tr>
                        <td class="player-id-cell"><div class="player-id">${pA.id}</div><div class="player-name">${pA.name}</div></td>
                        <td>${[...pA.characters].join(', ')}</td>
                        <td class="player-acs">${pA.acs}</td><td>${pA.k}</td><td>${pA.d}</td><td>${pA.a}</td><td>${pA.count}</td>
                        <td class="separator"></td>
                        <td class="player-id-cell"><div class="player-id">${pB.id}</div><div class="player-name">${pB.name}</div></td>
                        <td>${[...pB.characters].join(', ')}</td>
                        <td class="player-acs">${pB.acs}</td><td>${pB.k}</td><td>${pB.d}</td><td>${pB.a}</td><td>${pB.count}</td>
                    </tr>`;
                }

                const scoreHTML = matches.map(match => {
                    const isReversed = match.team_a !== team_a;
                    const scores = String(match.score).split(/[:/：]/).map(Number);
                    const scoreA = isReversed ? scores[1] : scores[0];
                    const scoreB = isReversed ? scores[0] : scores[1];
                    const scoreAClass = scoreA >= 13 ? 'score-win' : 'score-loss';
                    const scoreBClass = scoreB >= 13 ? 'score-win' : 'score-loss';
                    return `<div class="score-line"><span class="${scoreAClass}">${scoreA}</span>:<span class="${scoreBClass}">${scoreB}</span><span class="score-map">${match.map}</span></div>`;
                }).join('');

                const modalHTML = `
                    <table class="player-comparison-table">
                        <thead>
                            <tr>
                                <th colspan="7" class="team-name-header">${team_a}</th>
                                <th class="score-details">${scoreHTML}</th>
                                <th colspan="7" class="team-name-header">${team_b}</th>
                            </tr>
                            <tr class="stat-header">
                                <th>ID/真名</th><th>角色</th><th>平均ACS</th><th>总K</th><th>总D</th><th>总A</th><th>图数</th>
                                <th class="separator"></th>
                                <th>ID/真名</th><th>角色</th><th>平均ACS</th><th>总K</th><th>总D</th><th>总A</th><th>图数</th>
                            </tr>
                        </thead>
                        <tbody>${rowsHTML}</tbody>
                    </table>`;
                showModalWithContent(modalHTML);
            }
            
            function showTeamRoster(teamName, groupName) {
                const officialRoster = allPlayersData
                    .filter(p => p.team === teamName && p.group === groupName)
                    .map(p => p.id);
                
                const playedPlayers = {};
                const teamMatches = allMatchesData.filter(m => m.group === groupName && (m.team_a === teamName || m.team_b === teamName));

                const series = {};
                teamMatches.forEach(m => {
                    const opponent = m.team_a === teamName ? m.team_b : m.team_a;
                    const seriesKey = `${m.match_date}-${m.stage}-${opponent}`;
                    if (!series[seriesKey]) series[seriesKey] = [];
                    series[seriesKey].push(m);
                });

                Object.values(series).forEach(matchesInSeries => {
                    const playersInSeries = new Set();
                    matchesInSeries.forEach(match => {
                        const teamKey = match.team_a === teamName ? 'team_a' : 'team_b';
                        for(let i = 1; i <= 5; i++) {
                            const playerId = match[`${teamKey}_player${i}_id`];
                            if(playerId) playersInSeries.add(playerId);
                        }
                    });
                    playersInSeries.forEach(playerId => {
                        if (!playedPlayers[playerId]) playedPlayers[playerId] = { count: 0 };
                        playedPlayers[playerId].count++;
                    });
                });

                const finalRoster = officialRoster.map(id => ({
                    id, name: idNameMap[id] || id, isSub: false
                }));
                
                Object.keys(playedPlayers).forEach(playerId => {
                    if (!officialRoster.includes(playerId)) {
                        finalRoster.push({
                            id: playerId,
                            name: idNameMap[playerId] || playerId,
                            isSub: true,
                            subCount: playedPlayers[playerId].count
                        });
                    }
                });

                const rosterHTML = `
                    <div class="modal-header">${teamName} (${groupName}) 成员列表</div>
                    <ul class="roster-list">
                        ${finalRoster.length > 0 ? finalRoster.map(player => `
                            <li>
                                ${player.name} (${player.id})
                                ${player.isSub ? `<span class="sub-label">(替补 ${player.subCount} 次)</span>` : ''}
                            </li>
                        `).join('') : '<li>暂无该队伍成员信息</li>'}
                    </ul>
                `;
                showModalWithContent(rosterHTML);
            }

            matchesView.addEventListener('click', (e) => {
                const clickedCard = e.target.closest('.match-card');
                if (!clickedCard) return;
                
                const activeGroup = groupFilterButtons.querySelector('.active').dataset.group;
                const groupMatches = allMatchesData.filter(m => m.group === activeGroup);

                const matchIndex = parseInt(clickedCard.dataset.matchIndex, 10);
                const clickedMatch = groupMatches[matchIndex];
                if (!clickedMatch) return;

                if (mergeStatsCheckbox.checked) {
                    const { match_date, team_a, team_b, stage } = clickedMatch;
                    
                    const relatedMatches = groupMatches.filter(m =>
                        m.match_date === match_date && m.stage === stage &&
                        ((m.team_a === team_a && m.team_b === team_b) || (m.team_a === team_b && m.team_b === team_a))
                    );

                    if (relatedMatches.length > 0) {
                        showMatchDetails(relatedMatches);
                    } else {
                        showMatchDetails([clickedMatch]);
                    }
                } else {
                     showMatchDetails([clickedMatch]);
                }
            });

            standingsTableBody.addEventListener('click', (e) => {
                const clickedCell = e.target.closest('.team-name-cell');
                if (!clickedCell) return;
                const teamName = clickedCell.dataset.team;
                const activeGroup = groupFilterButtons.querySelector('.active').dataset.group;
                if(teamName) {
                    showTeamRoster(teamName, activeGroup);
                }
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('visible');
                }
            });
        });
    </script>
</body>
</html>