<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HWVCTS4 - 赛程中心</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #D64550;
            --bg-color: rgba(15, 25, 35, 0.85);
            --text-color: #ece8e1;
            --card-bg-color: rgba(26, 40, 54, 0.8);
            --header-bg-color: rgba(26, 40, 54, 0.85);
            --border-color: #2a3a49;
            --winner-color: #4CAF50;
            --loser-color: #F44336;
            --shadow-color: rgba(0,0,0,0.3);
            --control-height: 42px;
        }
        body.light-theme {
            --primary-color: #D64550;
            --bg-color: rgba(240, 242, 245, 0.85);
            --text-color: #1c1e21;
            --card-bg-color: rgba(255, 255, 255, 0.8);
            --header-bg-color: rgba(255, 255, 255, 0.85);
            --border-color: #dadde1;
            --shadow-color: rgba(0,0,0,0.1);
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px 0;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            background-image: url('https://cdna.artstation.com/p/assets/images/images/077/457/044/4k/envar-studio-valorant-homepage-illustration-01.jpg?1719495495');
            background-attachment: fixed;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
        }
        .container { width: 90%; max-width: 1400px; margin: 0 auto; }
        
        .main-header-block {
            background-color: var(--header-bg-color);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 16px var(--shadow-color);
            text-align: center;
            margin-bottom: 40px;
            border: 1px solid var(--border-color);
            position: relative;
        }
        .main-header-block h1 { color: var(--primary-color); margin: 0 0 10px 0; font-weight: 700; font-size: 2.5em; }
        .controls-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
        }
        .filter-group, .nav-button {
            height: var(--control-height);
            display: inline-flex;
            align-items: center;
            border-radius: 8px;
            font-weight: 500;
        }
        .filter-group { background-color: var(--card-bg-color); padding: 5px; border: 1px solid var(--border-color); }
        .filter-group button { padding: 0 15px; border: none; background-color: transparent; color: var(--text-color); opacity: 0.7; cursor: pointer; border-radius: 6px; font-size: 0.9em; height: 100%; transition: background-color 0.3s, color 0.3s; }
        .filter-group button.active { background-color: var(--primary-color); color: white; opacity: 1; }
        .nav-button { padding: 0 25px; border: 2px solid var(--primary-color); color: var(--primary-color); text-decoration: none; transition: background-color 0.3s, color 0.3s; }
        .nav-button:hover { background-color: var(--primary-color); color: white; }

        .content-block {
            background-color: var(--card-bg-color);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 16px var(--shadow-color);
        }
        .content-block h3 {
            text-align: center;
            font-size: 1.5em;
            color: var(--text-color);
            opacity: 0.9;
            margin-top: 0;
            margin-bottom: 20px;
        }
        .bracket-container {
            width: 100%;
            overflow-x: auto;
            padding-bottom: 15px;
        }
        .bracket {
            display: flex;
            justify-content: center;
            gap: 40px;
            min-width: max-content;
            padding: 20px;
            position: relative;
        }
        .round {
            display: flex;
            flex-direction: column;
            gap: 20px;
            justify-content: center;
            flex-shrink: 0;
            width: 190px;
        }
        .round-title {
            text-align: center;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        .match-card, .result-card {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            width: 100%;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .match-card.clickable:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px var(--shadow-color);
        }
        .team { display: flex; justify-content: space-between; align-items: center; padding: 2px 0; }
        .team-name { font-size: 1em; }
        .team-score { font-weight: bold; }
        .team.winner .team-name { color: var(--winner-color); }
        .team.loser .team-name { opacity: 0.6; }
        hr { border-color: var(--border-color); margin: 5px 0; }
        .result-card {
            border-width: 2px;
            text-align: center;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
        }
        .promoted { border-color: var(--winner-color); }
        .champion { border-color: var(--winner-color); font-size: 1.5em; background-color: rgba(76, 175, 80, 0.1); }
        .eliminated { border-color: var(--loser-color); opacity: 0.8; }
        
        .theme-switch-wrapper { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 10px; }
        #theme-text { font-size: 0.8em; opacity: 0.8; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { background-color: var(--border-color); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: var(--text-color); bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-header-block">
            <div class="theme-switch-wrapper">
                <span id="theme-text"></span>
                <label class="theme-switch">
                    <input type="checkbox" id="theme-toggle-checkbox">
                    <span class="slider"></span>
                </label>
            </div>
            <h1>HWVCTS4 赛程中心</h1>
            <div class="controls-container">
                <a href="index.html" class="nav-button">返回比赛中心</a>
                <a href="summary.html" class="nav-button" target="_blank">查看选手数据</a>
            </div>
            <div class="controls-container" style="margin-top: 20px;">
                 <div class="filter-group" id="group-filters">
                    <button class="active" data-group="传奇组">传奇组</button>
                    <button data-group="中坚组">中坚组</button>
                    <button data-group="挑战组">挑战组</button>
                </div>
                <div class="filter-group" id="stage-filters">
                    <button class="active" data-stage="swiss">小组赛</button>
                    <button data-stage="playoff">淘汰赛</button>
                </div>
                <div class="filter-group">
                    <input type="text" id="seed-input" placeholder="输入随机种子" style="height: calc(var(--control-height) - 12px); border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color); padding: 0 10px;">
                    <button id="random-draw-btn" style="padding: 0 15px; border: none; background-color: transparent; color: var(--text-color); cursor: pointer; border-radius: 6px; font-size: 0.9em; height: 100%;">随机生成对战</button>
                </div>
            </div>
        </div>

        <main class="content-block">
            <h2 id="current-group-name"></h2>
            <div id="swiss-stage-section">
                <h3>小组赛 (点击比赛卡片跳转回放)</h3>
                <div class="bracket-container">
                    <div id="swiss-bracket" class="bracket"></div>
                </div>
            </div>
            <div id="playoff-stage-section" style="display: none;">
                <h3>淘汰赛 (点击比赛卡片跳转回放)</h3>
                <div class="bracket-container">
                    <div id="playoff-bracket" class="bracket"></div>
                </div>
            </div>
        </main>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const SUPABASE_URL = 'https://vbyvolmtkjjyeiibpljf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZieXZvbG10a2pqeWVpaWJwbGpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NzMxNDksImV4cCI6MjA3MjI0OTE0OX0.Tnot1kIVn8vJ-vggYaTGBGTkIBY7m6yIOquSjG5mSUM';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        const groupFilters = document.getElementById('group-filters');
        const stageFilters = document.getElementById('stage-filters');
        const swissSection = document.getElementById('swiss-stage-section');
        const playoffSection = document.getElementById('playoff-stage-section');
        const themeToggle = document.getElementById('theme-toggle-checkbox');
        const themeText = document.getElementById('theme-text');
        const randomDrawBtn = document.getElementById('random-draw-btn');
        let allMatchesData = {};
        
        function setTheme(isLight) {
            document.body.classList.toggle('light-theme', isLight);
            themeToggle.checked = isLight;
            themeText.textContent = isLight ? '点击切换夜间模式' : '点击切换日间模式';
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }
        const savedTheme = localStorage.getItem('theme');
        setTheme((savedTheme === null) ? true : (savedTheme === 'light'));
        themeToggle.addEventListener('change', (e) => setTheme(e.target.checked));

        const swissBracketLayout = [
            { type: 'round', content: [ { title: '0-0组', ids: ['S1-1', 'S1-2', 'S1-3', 'S1-4'] } ] },
            { type: 'round', content: [ { title: '1-0组', ids: ['S2-1W', 'S2-2W'] }, { title: '0-1组', ids: ['S2-1L', 'S2-2L'] } ] },
            { type: 'round', content: [ { title: '2-0 晋级', ids: ['S3-PROMO-A', 'S3-PROMO-B'], type: 'promoted' }, { title: '1-1组', ids: ['S3-1M', 'S3-2M'] }, { title: '0-2 淘汰', ids: ['S3-ELIM-A', 'S3-ELIM-B'], type: 'eliminated' } ] },
            { type: 'round', content: [ { title: '2-1 晋级', ids: ['S4-PROMO-A', 'S4-PROMO-B'], type: 'promoted' }, { title: '1-2 淘汰', ids: ['S4-ELIM-A', 'S4-ELIM-B'], type: 'eliminated' } ] }
        ];

        const playoffBracketLayout = [
            { type: 'round', content: [ { title: '胜者组 R1', ids: ['P-WB1-1', 'P-WB1-2'] } ] },
            { type: 'round', content: [ { title: '胜者组决赛', ids: ['P-WBF'] }, { title: '败者组 R1', ids: ['P-LB1'] } ] },
            { type: 'round', content: [ { title: '败者组决赛', ids: ['P-LBF'] } ] },
            { type: 'round', content: [ { title: '总决赛', ids: ['P-GF'] } ] },
            { type: 'round', content: [ { title: '总冠军', ids: ['P-CHAMPION'], type: 'champion' } ] }
        ];

        function getWinner(match) {
            if (!match || typeof match.score_a === 'undefined' || typeof match.score_b === 'undefined' || match.score_a === null || match.score_b === null) return null;
            return Number(match.score_a) > Number(match.score_b) ? match.team_a : match.team_b;
        }

        function getLoser(match) {
            if (!match || typeof match.score_a === 'undefined' || typeof match.score_b === 'undefined' || match.score_a === null || match.score_b === null) return null;
            return Number(match.score_a) < Number(match.score_b) ? match.team_a : match.team_b;
        }
        
        function processResultNodes(rawData) {
            const data = JSON.parse(JSON.stringify(rawData));
            const ensureNodeExists = (id) => { if (!data[id]) data[id] = {}; };
            ensureNodeExists('S3-PROMO-A'); data['S3-PROMO-A'].result_team = getWinner(data['S2-1W']);
            ensureNodeExists('S3-PROMO-B'); data['S3-PROMO-B'].result_team = getWinner(data['S2-2W']);
            ensureNodeExists('S3-ELIM-A'); data['S3-ELIM-A'].result_team = getLoser(data['S2-1L']);
            ensureNodeExists('S3-ELIM-B'); data['S3-ELIM-B'].result_team = getLoser(data['S2-2L']);
            ensureNodeExists('S4-PROMO-A'); data['S4-PROMO-A'].result_team = getWinner(data['S3-1M']);
            ensureNodeExists('S4-PROMO-B'); data['S4-PROMO-B'].result_team = getWinner(data['S3-2M']);
            ensureNodeExists('S4-ELIM-A'); data['S4-ELIM-A'].result_team = getLoser(data['S3-1M']);
            ensureNodeExists('S4-ELIM-B'); data['S4-ELIM-B'].result_team = getLoser(data['S3-2M']);
            ensureNodeExists('P-CHAMPION'); data['P-CHAMPION'].result_team = getWinner(data['P-GF']);
            return data;
        }

        async function loadData() {
            try {
                const { data, error } = await supabaseClient.from('match_schedule').select('*');
                if (error) throw error;

                allMatchesData = {}; // Clear previous data
                data.forEach(row => {
                    if (!allMatchesData[row.group]) {
                        allMatchesData[row.group] = {};
                    }
                    if (row.match_id) {
                        allMatchesData[row.group][String(row.match_id).trim()] = row;
                    }
                });

                renderBrackets('传奇组');
            } catch (error) {
                console.error("加载或解析赛程数据失败:", error);
                document.getElementById('swiss-bracket').innerHTML = `<p style="color:red; text-align:center;">无法加载赛程数据: ${error.message}</p>`;
            }
        }
        
        function createMatchCard(data) {
            const teamA = data?.team_a || 'TBD';
            const teamB = data?.team_b || 'TBD';
            // Use ?? to handle null or undefined scores, defaulting to 0
            const scoreA = data?.score_a ?? 0;
            const scoreB = data?.score_b ?? 0;
            const winnerA = Number(scoreA) > Number(scoreB);
            const winnerB = Number(scoreB) > Number(scoreA);
            const card = document.createElement('div');
            card.className = 'match-card';
            if (data && data.link) {
                card.classList.add('clickable');
                card.dataset.link = data.link;
                card.style.cursor = 'pointer';
            }
            card.innerHTML = `
                <div class="team ${winnerA ? 'winner' : ''} ${winnerB ? 'loser' : ''}"><span class="team-name">${teamA}</span><span class="team-score">${scoreA}</span></div>
                <hr>
                <div class="team ${winnerB ? 'winner' : ''} ${winnerA ? 'loser' : ''}"><span class="team-name">${teamB}</span><span class="team-score">${scoreB}</span></div>
            `;
            return card;
        }

        function createResultCard(data, type = '') {
            const team = data?.result_team || 'TBD';
            const card = document.createElement('div');
            card.className = `result-card ${type}`;
            card.textContent = team;
            return card;
        }
        
        function buildBracket(container, layout, data) {
            container.innerHTML = '';
            layout.forEach(col => {
                const roundDiv = document.createElement('div');
                roundDiv.className = 'round';
                col.content.forEach(group => {
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'round-title';
                    titleDiv.textContent = group.title;
                    roundDiv.appendChild(titleDiv);
                    group.ids.forEach(id => {
                        const cardData = data[id];
                        let cardElement;
                        if (group.type) { 
                            cardElement = createResultCard(cardData, group.type);
                        } else { 
                            cardElement = createMatchCard(cardData);
                        }
                        roundDiv.appendChild(cardElement);
                    });
                });
                container.appendChild(roundDiv);
            });
        }

        function renderBrackets(groupName) {
            const rawData = allMatchesData[groupName] || {};
            const processedData = processResultNodes(rawData);
            document.getElementById('current-group-name').textContent = `${groupName}赛程`;
            buildBracket(document.getElementById('swiss-bracket'), swissBracketLayout, processedData);
            buildBracket(document.getElementById('playoff-bracket'), playoffBracketLayout, processedData);
        }

        // --- New Functionality Starts Here ---

        function seededRandom(seed) {
            let state = seed;
            return function() {
                state = (state * 9301 + 49297) % 233280;
                return state / 233280;
            };
        }

        function shuffleArray(array, randomFunc) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(randomFunc() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function randomlyAssignTeams() {
            const groupName = groupFilters.querySelector('.active').dataset.group;
            const groupData = allMatchesData[groupName] || {};

            // 1. Calculate team records
            const teamRecords = {};
            const allTeams = new Set();
            
            Object.values(groupData).forEach(match => {
                if (match.team_a && match.team_a !== 'TBD') allTeams.add(match.team_a);
                if (match.team_b && match.team_b !== 'TBD') allTeams.add(match.team_b);
            });
            allTeams.forEach(team => {
                teamRecords[team] = { wins: 0, losses: 0 };
            });

            Object.values(groupData).forEach(match => {
                 if (typeof match.score_a !== 'undefined' && typeof match.score_b !== 'undefined' && match.score_a !== null && match.score_b !== null) {
                    const winner = getWinner(match);
                    const loser = getLoser(match);
                    if (winner && teamRecords[winner]) teamRecords[winner].wins++;
                    if (loser && teamRecords[loser]) teamRecords[loser].losses++;
                }
            });
            
            // 2. Group teams by record
            const teamsByRecord = {};
            for (const team in teamRecords) {
                const record = `${teamRecords[team].wins}-${teamRecords[team].losses}`;
                if (!teamsByRecord[record]) teamsByRecord[record] = [];
                teamsByRecord[record].push(team);
            }

            // 3. Get seed and shuffle
            const seedInput = document.getElementById('seed-input').value;
            const seed = seedInput ? parseInt(seedInput) : new Date().getTime();
            const randomFunc = seededRandom(seed);
            for (const record in teamsByRecord) {
                shuffleArray(teamsByRecord[record], randomFunc);
            }

            // 4. Assign teams to the next round's matches
            const assignments = {
                '1-0': ['S2-1W', 'S2-2W'],
                '0-1': ['S2-1L', 'S2-2L'],
                '1-1': ['S3-1M', 'S3-2M']
            };
            const dataToUpsert = [];

            for (const record in assignments) {
                const teams = teamsByRecord[record] || [];
                const matchIds = assignments[record];
                
                if (teams.length >= 2) {
                     let teamIndex = 0;
                     for (const matchId of matchIds) {
                         if (!groupData[matchId] || groupData[matchId].team_a === 'TBD' || !groupData[matchId].team_a) {
                            if (!groupData[matchId]) groupData[matchId] = { match_id: matchId, group: groupName };
                            
                            let teamA = 'TBD', teamB = 'TBD';
                            if (teamIndex < teams.length) teamA = teams[teamIndex++];
                            if (teamIndex < teams.length) teamB = teams[teamIndex++];
                            
                            // Update local data for immediate re-render
                            groupData[matchId].team_a = teamA;
                            groupData[matchId].team_b = teamB;
                            groupData[matchId].score_a = 0;
                            groupData[matchId].score_b = 0;

                            // Add this matchup to the upsert array
                            dataToUpsert.push({
                                group: groupName,
                                match_id: matchId,
                                team_a: teamA,
                                team_b: teamB,
                                score_a: 0,
                                score_b: 0
                            });
                         }
                     }
                }
            }
            
            // 5. Call Supabase to save the data
            if (dataToUpsert.length > 0) {
                const { error } = await supabaseClient.from('match_schedule').upsert(dataToUpsert, { onConflict: 'group, match_id' });
                if (error) {
                    alert('自动保存赛程失败: ' + error.message);
                    console.error(error);
                    return;
                }
                alert(`使用种子 ${seed} 生成对战成功！赛程已自动保存。`);
            } else {
                alert(`没有可生成的对战，请确保上一轮比赛已完成或队伍池正确。`);
            }
            
            // 6. Re-render the bracket with updated local data
            renderBrackets(groupName);
        }

        randomDrawBtn.addEventListener('click', randomlyAssignTeams);

        // --- New Functionality Ends Here ---

        document.querySelectorAll('.bracket').forEach(bracket => {
            bracket.addEventListener('click', e => {
                const clickableCard = e.target.closest('.match-card.clickable');
                if (clickableCard && clickableCard.dataset.link) {
                    window.open(clickableCard.dataset.link, '_blank', 'noopener,noreferrer');
                }
            });
        });

        groupFilters.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
                groupFilters.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                renderBrackets(e.target.dataset.group);
            }
        });

        stageFilters.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
                stageFilters.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                const stage = e.target.dataset.stage;
                swissSection.style.display = (stage === 'swiss') ? 'block' : 'none';
                playoffSection.style.display = (stage === 'playoff') ? 'block' : 'none';
            }
        });

        loadData();
    });
</script>
</body>
</html>